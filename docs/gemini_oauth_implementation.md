# Gemini CLI OAuth Personal Backend Implementation

## Overview

Successfully implemented the `gemini-cli-oauth-personal` backend that uses OAuth2 authentication with the Google Code Assist API, exactly like KiloCode's "Google CLI" authentication method.

## Key Features

- **OAuth2 Authentication**: Uses the same OAuth credentials generated by the official `gemini` CLI tool
- **No API Key Required**: Works without needing a Gemini API key
- **Free Tier Support**: Automatically uses the free tier with managed Google Cloud project
- **Token Auto-Refresh**: Automatically refreshes expired OAuth tokens
- **Windows Path Support**: Can use custom paths for the `.gemini` directory

## How It Works

### Authentication Flow

1. **Loads OAuth credentials** from `~/.gemini/oauth_creds.json` (or custom path)
2. **Refreshes token** if expired using Google's OAuth2 refresh mechanism
3. **Discovers project ID** by calling `loadCodeAssist` endpoint
4. **Onboards to free tier** if no project exists (creates managed project)
5. **Makes API calls** using the Code Assist API with SSE streaming

### Critical Implementation Details

#### 1. API Endpoints

- Base URL: `https://cloudcode-pa.googleapis.com`
- API Version: `v1internal`
- Key endpoints:
  - `:loadCodeAssist` - Check existing project
  - `:onboardUser` - Onboard to free tier
  - `:streamGenerateContent` - Generate responses (with `?alt=sse`)

#### 2. OAuth Configuration

```python
CLIENT_ID = "XXXXXXX.apps.googleusercontent.com"
CLIENT_SECRET = "XXXXXX-XXXX-XXXX-XXXXXXX"
SCOPES = [
    "https://www.googleapis.com/auth/cloud-platform",
    "https://www.googleapis.com/auth/userinfo.email",
    "https://www.googleapis.com/auth/userinfo.profile",
]
```

#### 3. Free Tier Onboarding

**CRITICAL**: For free-tier onboarding:

- **DO NOT** include `cloudaicompanionProject` field in the request
- Use tier ID `"free-tier"` when standard-tier requires user project
- The API returns a managed project ID (e.g., `charismatic-fragment-mxnz0`)

#### 4. Model Names

Must use the correct model names:

- ‚úÖ `"gemini-1.5-flash-002"`
- ‚úÖ `"gemini-2.0-flash-001"`
- ‚ùå `"gemini-pro"` (doesn't exist in Code Assist)

## Usage

### Basic Setup

1. Install the `gemini` CLI and authenticate:

```bash
gemini auth login
```

2. This creates `~/.gemini/oauth_creds.json` with OAuth tokens

3. Use the backend in your code:

```python
backend = GeminiOAuthPersonalConnector(
    client,
    gemini_cli_oauth_path="C:/Users/YourName/.gemini"  # Optional custom path
)
await backend.initialize()
```

### Configuration

The backend can be configured with:

- `gemini_cli_oauth_path`: Custom path to `.gemini` directory (useful for WSL/Windows scenarios)

## Troubleshooting

### Common Issues

1. **403 Permission Denied on "default" project**
   - Cause: Trying to use standard-tier without a Google Cloud project
   - Solution: Implementation automatically falls back to free-tier

2. **404 Model Not Found**
   - Cause: Using wrong model names (e.g., "gemini-pro")
   - Solution: Use correct Code Assist model names

3. **Token Expired**
   - Solution: Implementation automatically refreshes tokens

## Differences from KiloCode

Our implementation matches KiloCode's approach exactly:

- Same OAuth client credentials
- Same API endpoints
- Same request/response format
- Same free-tier onboarding logic

## Testing

Test script available at `test_updated_gemini_oauth.py`:

```python
python test_updated_gemini_oauth.py
```

Expected output:

```
‚úÖ Backend initialized successfully!
‚úÖ Chat completion successful!
üìù Assistant response: [Generated text]
```

## Files Modified

- `src/connectors/gemini_oauth_personal.py` - Main implementation
- Inherits from `GeminiBackend` for model management
- Registered in backend registry as `"gemini-cli-oauth-personal"`

## Security Considerations

- OAuth credentials are stored locally in user's home directory
- Tokens are automatically refreshed before expiry
- No API keys or sensitive data in code
- Uses Google's official OAuth2 client ID/secret (public for CLI apps)

## Future Improvements

1. Add support for streaming responses
2. Implement rate limiting handling
3. Add support for more model-specific features
4. Cache project ID to avoid repeated discovery calls

## Conclusion

The `gemini-cli-oauth-personal` backend successfully replicates KiloCode's "Google CLI" authentication method, providing free access to Gemini models through OAuth2 authentication without requiring API keys or Google Cloud project setup.
