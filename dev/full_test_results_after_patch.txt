============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0
rootdir: C:\Users\Mateusz\source\repos\llm-interactive-proxy
configfile: pyproject.toml
plugins: anyio-4.10.0, asyncio-1.1.0, cov-6.2.1, httpx-0.35.0, mock-3.14.1, snapshot-0.9.0, respx-0.22.0
asyncio: mode=auto, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 864 items / 43 deselected / 821 selected

dev\test_api_key_redaction.py ..                                         [  0%]
tests\chat_completions_tests\test_anthropic_api_compatibility.py ..      [  0%]
tests\chat_completions_tests\test_anthropic_frontend.py ....             [  0%]
tests\integration\commands\loop_detection_commands\test_integration_loop_detection_command.py s [  1%]
ss                                                                       [  1%]
tests\integration\commands\loop_detection_commands\test_integration_tool_loop_detection_command.py s [  1%]
ss                                                                       [  1%]
tests\integration\commands\loop_detection_commands\test_integration_tool_loop_max_repeats_command.py s [  1%]
s                                                                        [  1%]
tests\integration\commands\loop_detection_commands\test_integration_tool_loop_mode_command.py s [  2%]
s                                                                        [  2%]
tests\integration\commands\loop_detection_commands\test_integration_tool_loop_ttl_command.py s [  2%]
s                                                                        [  2%]
tests\integration\commands\test_integration_failover_commands.py s       [  2%]
tests\integration\commands\test_integration_hello_command.py .           [  2%]
tests\integration\commands\test_integration_help_command.py ...          [  3%]
tests\integration\commands\test_integration_model_command.py ...         [  3%]
tests\integration\commands\test_integration_oneoff_command.py ..         [  3%]
tests\integration\commands\test_integration_project_command.py ..        [  3%]
tests\integration\commands\test_integration_pwd_command.py ..            [  4%]
tests\integration\commands\test_integration_set_command.py ..            [  4%]
tests\integration\commands\test_integration_temperature_command.py ..    [  4%]
tests\integration\commands\test_integration_unset_command.py ....        [  5%]
tests\integration\test_anthropic_frontend_integration.py ............... [  6%]
.....s                                                                   [  7%]
tests\integration\test_app.py ...                                        [  8%]
tests\integration\test_backend_probing.py ....s                          [  8%]
tests\integration\test_cline_tool_call_implementation.py sssssssssssss   [ 10%]
tests\integration\test_direct_controllers.py ....                        [ 10%]
tests\integration\test_end_to_end_loop_detection.py ssss                 [ 11%]
tests\integration\test_failover_routes.py s..                            [ 11%]
tests\integration\test_hello_command_integration.py .                    [ 11%]
tests\integration\test_models_endpoints.py ..Fs...........               [ 13%]
tests\integration\test_multimodal_integration.py ......                  [ 14%]
tests\integration\test_new_architecture.py .....F                        [ 14%]
tests\integration\test_oneoff_command_integration.py .                   [ 15%]
tests\integration\test_oneoff_commands_minimal.py ....                   [ 15%]
tests\integration\test_phase1_integration.py ......                      [ 16%]
tests\integration\test_pwd_command_integration.py ..                     [ 16%]
tests\integration\test_real_world_loop_detection.py ......               [ 17%]
tests\integration\test_tool_call_loop_detection.py ssssss                [ 18%]
tests\integration\test_versioned_api.py ....                             [ 18%]
tests\regression\test_mock_backend_regression.py ......                  [ 19%]
tests\test_enforcement_demo.py ..                                        [ 19%]
tests\test_top_p_fix.py .                                                [ 19%]
tests\unit\anthropic_connector_tests\test_domain_to_connector.py ......  [ 20%]
tests\unit\anthropic_frontend_tests\test_anthropic_accounting.py ....... [ 21%]
.......                                                                  [ 22%]
tests\unit\anthropic_frontend_tests\test_anthropic_converters.py ....... [ 22%]
.........                                                                [ 23%]
tests\unit\anthropic_frontend_tests\test_anthropic_router.py ........... [ 25%]
........                                                                 [ 26%]
tests\unit\chat_completions_tests\test_basic_proxying.py ..              [ 26%]
tests\unit\chat_completions_tests\test_commands_disabled.py .            [ 26%]
tests\unit\chat_completions_tests\test_error_handling.py ..F             [ 27%]
tests\unit\chat_completions_tests\test_gemini_api_compatibility.py ..... [ 27%]
....                                                                     [ 28%]
tests\unit\chat_completions_tests\test_multimodal_cross_protocol.py .s   [ 28%]
tests\unit\chat_completions_tests\test_rate_limit_wait.py s              [ 28%]
tests\unit\chat_completions_tests\test_rate_limiting.py F                [ 28%]
tests\unit\chat_completions_tests\test_real_cline_response.py sssssss    [ 29%]
tests\unit\chat_completions_tests\test_session_history.py ss             [ 29%]
tests\unit\commands\loop_detection_commands\test_unit_loop_detection_command.py s [ 29%]
ss                                                                       [ 30%]
tests\unit\commands\loop_detection_commands\test_unit_tool_loop_detection_command.py s [ 30%]
ss                                                                       [ 30%]
tests\unit\commands\loop_detection_commands\test_unit_tool_loop_max_repeats_command.py s [ 30%]
sss                                                                      [ 30%]
tests\unit\commands\loop_detection_commands\test_unit_tool_loop_mode_command.py s [ 31%]
sss                                                                      [ 31%]
tests\unit\commands\loop_detection_commands\test_unit_tool_loop_ttl_command.py s [ 31%]
sss                                                                      [ 31%]
tests\unit\commands\test_set_command.py .......                          [ 32%]
tests\unit\commands\test_unit_failover_commands.py ...                   [ 33%]
tests\unit\commands\test_unit_help_command.py ...                        [ 33%]
tests\unit\commands\test_unit_model_command.py ...                       [ 33%]
tests\unit\commands\test_unit_oneoff_command.py ....                     [ 34%]
tests\unit\commands\test_unit_project_command.py ..                      [ 34%]
tests\unit\commands\test_unit_pwd_command.py ..                          [ 34%]
tests\unit\commands\test_unit_set_command.py ........                    [ 35%]
tests\unit\commands\test_unit_temperature_command.py ....                [ 36%]
tests\unit\commands\test_unit_unset_command.py ....                      [ 36%]
tests\unit\core\app\test_application_factory.py .......                  [ 37%]
tests\unit\core\common\test_logging_utils.py ..........                  [ 38%]
tests\unit\core\test_authentication.py ......................            [ 41%]
tests\unit\core\test_backend_config_provider.py .........                [ 42%]
tests\unit\core\test_backend_factory_ensure_backend.py .......           [ 43%]
tests\unit\core\test_backend_service_enhanced.py ......s..............   [ 46%]
tests\unit\core\test_config.py .......                                   [ 46%]
tests\unit\core\test_configuration_interfaces.py ...............         [ 48%]
tests\unit\core\test_di_container.py ......                              [ 49%]
tests\unit\core\test_domain_models.py ......                             [ 50%]
tests\unit\core\test_failover_service.py ...                             [ 50%]
tests\unit\core\test_hello_command.py .                                  [ 50%]
tests\unit\core\test_logging_utils.py .......                            [ 51%]
tests\unit\core\test_multimodal.py ........................              [ 54%]
tests\unit\core\test_request_processor.py .....                          [ 55%]
tests\unit\core\test_session_service.py .....                            [ 55%]
tests\unit\gemini_connector_tests\test_http_error_streaming.py .         [ 55%]
tests\unit\gemini_connector_tests\test_model_prefix_handling.py .        [ 55%]
tests\unit\gemini_connector_tests\test_multimodal_payload.py ..          [ 56%]
tests\unit\gemini_connector_tests\test_part_conversion.py ..             [ 56%]
tests\unit\gemini_connector_tests\test_streaming_success.py .            [ 56%]
tests\unit\gemini_connector_tests\test_temperature_handling.py ........  [ 57%]
tests\unit\loop_detection\test_detector.py ..........                    [ 58%]
tests\unit\loop_detection\test_streaming_wrapper.py .                    [ 58%]
tests\unit\loop_detection\test_tool_call_tracker.py .................    [ 60%]
tests\unit\openai_connector_tests\test_integration.py s                  [ 61%]
tests\unit\openai_connector_tests\test_streaming_response.py .....       [ 61%]
tests\unit\openai_connector_tests\test_url_override.py ...               [ 61%]
tests\unit\openrouter_connector_tests\test_headers_plumbing.py .         [ 62%]
tests\unit\openrouter_connector_tests\test_http_error_non_streaming.py . [ 62%]
                                                                         [ 62%]
tests\unit\openrouter_connector_tests\test_http_error_streaming.py .     [ 62%]
tests\unit\openrouter_connector_tests\test_non_streaming_success.py .    [ 62%]
tests\unit\openrouter_connector_tests\test_payload_construction_and_headers.py . [ 62%]
........                                                                 [ 63%]
tests\unit\openrouter_connector_tests\test_request_error.py .            [ 63%]
tests\unit\openrouter_connector_tests\test_streaming_success.py .        [ 63%]
tests\unit\openrouter_connector_tests\test_temperature_handling.py ..... [ 64%]
.....                                                                    [ 65%]
tests\unit\proxy_logic_tests\test_parse_arguments.py ............        [ 66%]
tests\unit\proxy_logic_tests\test_process_commands_in_messages.py ...... [ 67%]
...............                                                          [ 69%]
tests\unit\proxy_logic_tests\test_process_text_for_commands.py ......... [ 70%]
...............                                                          [ 71%]
tests\unit\test_agent_utils.py .....                                     [ 72%]
tests\unit\test_auth.py ....                                             [ 73%]
tests\unit\test_cli.py ..............ss..........                        [ 76%]
tests\unit\test_command_parser_process_messages.py ......                [ 76%]
tests\unit\test_command_parser_process_text.py ..............            [ 78%]
tests\unit\test_config.py .........                                      [ 79%]
tests\unit\test_config_persistence.py ..                                 [ 80%]
tests\unit\test_emergency_command_filter.py ........                     [ 80%]
tests\unit\test_failover_routes.py ...                                   [ 81%]
tests\unit\test_gemini_converters.py ......                              [ 82%]
tests\unit\test_get_command_pattern.py ..                                [ 82%]
tests\unit\test_mock_backends.py .....sss                                [ 83%]
tests\unit\test_model_discovery.py ....                                  [ 83%]
tests\unit\test_models_endpoint.py ..                                    [ 84%]
tests\unit\test_no_prints.py .                                           [ 84%]
tests\unit\test_parse_arguments.py ......                                [ 84%]
tests\unit\test_prompt_redaction.py .                                    [ 85%]
tests\unit\test_proxy_logic.py .......                                   [ 85%]
tests\unit\test_qwen_oauth_authentication.py ..................          [ 88%]
tests\unit\test_qwen_oauth_connector.py ............................     [ 91%]
tests\unit\test_qwen_oauth_enhanced_error_handling.py ..........         [ 92%]
tests\unit\test_qwen_oauth_interactive_commands.py .sss....s             [ 93%]
tests\unit\test_qwen_oauth_tool_calling.py .......                       [ 94%]
tests\unit\test_qwen_oauth_tool_calling_enhanced.py .......              [ 95%]
tests\unit\test_rate_limit.py ..                                         [ 95%]
tests\unit\test_response_shape.py ..                                     [ 95%]
tests\unit\test_security.py .....                                        [ 96%]
tests\unit\test_session_manager.py ...                                   [ 96%]
tests\unit\test_streaming_normalizer.py .......                          [ 97%]
tests\unit\test_tool_call_loop_middleware.py .......                     [ 98%]
tests\unit\test_transport_adapters.py ......                             [ 99%]
tests\unit\zai_connector_tests\test_domain_to_connector.py .....         [100%]

================================== FAILURES ===================================
_____________ TestModelsEndpoints.test_models_endpoint_with_auth ______________

self = <tests.integration.test_models_endpoints.TestModelsEndpoints object at 0x000001FDE64C8BE0>
app_with_auth_enabled = <fastapi.applications.FastAPI object at 0x000001FDEC892650>

    def test_models_endpoint_with_auth(self, app_with_auth_enabled):
        """Test /models endpoint with authentication."""
        with TestClient(app_with_auth_enabled) as client:
            # Without auth - should fail
            response = client.get("/models")
            assert response.status_code == 401
    
            # With valid auth
            response = client.get(
                "/models", headers={"Authorization": "Bearer test-key-123"}
            )
>           assert response.status_code == 200
E           assert 401 == 200
E            +  where 401 = <Response [401 Unauthorized]>.status_code

tests\integration\test_models_endpoints.py:71: AssertionError
---------------------------- Captured stdout setup ----------------------------
SKIPPING global mock for test: test_models_endpoint_with_auth in module: tests.integration.test_models_endpoints
2025-08-20 19:00:57 [info     ] API Key authentication is enabled key_count=1
2025-08-20 19:00:57 [info     ] Auth token validation is enabled
----------------------------- Captured log setup ------------------------------
INFO     src.core.config.app_config:app_config.py:470 AppConfig.from_env - Determined default_backend: openai
INFO     src.core.config.app_config:app_config.py:544 Added test API key for default backend openai
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: MockBackendStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.test_stages:test_stages.py:43 Initializing mock backend services...
DEBUG    src.core.app.stages.test_stages:test_stages.py:87 Registered mock backend config provider
DEBUG    src.core.app.stages.test_stages:test_stages.py:345 Registered mock backend factory
DEBUG    src.core.app.stages.test_stages:test_stages.py:310 Registered mock backend service with full method coverage
DEBUG    src.core.app.stages.test_stages:test_stages.py:427 Overrode session service to ensure real Session objects
INFO     src.core.app.stages.test_stages:test_stages.py:60 Mock backend services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 13 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
------------------------------ Captured log call ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
WARNING  src.core.security.middleware:middleware.py:161 Invalid or missing auth token for GET /models from client testclient
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/models "HTTP/1.1 401 Unauthorized"
WARNING  src.core.security.middleware:middleware.py:161 Invalid or missing auth token for GET /models from client testclient
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/models "HTTP/1.1 401 Unauthorized"
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
___________________________ test_anthropic_endpoint ___________________________

client = <starlette.testclient.TestClient object at 0x000001FDEC7A67A0>

    def test_anthropic_endpoint(client: TestClient) -> None:
        """Test that the Anthropic endpoint works."""
        # Create an Anthropic request
        request_data = {
            "model": "claude-3-opus-20240229",
            "messages": [{"role": "user", "content": "Hello, world!"}],
            "stream": False,
        }
    
        # Send the request
        response = client.post("/anthropic/v1/messages", json=request_data)
    
        # Check the response
        assert response.status_code == 200
        assert response.headers["content-type"] == "application/json"
    
        # Parse the response
        response_data = response.json()
    
        # Check the response data
        # The response is wrapped in a ResponseEnvelope
        assert "content" in response_data
        content = response_data["content"]
    
        # Check the content has the expected OpenAI format that's converted to Anthropic format
>       assert "id" in content
E       AssertionError: assert 'id' in [{'text': 'mock', 'type': 'text'}]

tests\integration\test_new_architecture.py:325: AssertionError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_anthropic_endpoint in module: tests.integration.test_new_architecture
2025-08-20 19:00:59 [info     ] API Key authentication is disabled
----------------------------- Captured log setup ------------------------------
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: BackendStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.backend:backend.py:52 Initializing backend services...
DEBUG    src.core.app.stages.backend:backend.py:57 Imported connectors, registered backends: ['gemini', 'openai', 'openrouter', 'qwen-oauth', 'zai']
DEBUG    src.core.app.stages.backend:backend.py:88 Registered backend registry instance
DEBUG    src.core.app.stages.backend:backend.py:116 Registered backend factory with dependencies
DEBUG    src.core.app.stages.backend:backend.py:141 Registered backend config provider
DEBUG    src.core.app.stages.backend:backend.py:189 Registered backend service with all dependencies
INFO     src.core.app.stages.backend:backend.py:75 Backend services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 11 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
---------------------------- Captured stdout call -----------------------------
2025-08-20 19:00:59 [debug    ] Initialized failover service   failover_routes={}
------------------------------ Captured log call ------------------------------
INFO     src.anthropic_router:anthropic_router.py:53 Anthropic messages request for model: claude-3-opus-20240229
DEBUG    src.core.app.stages.processor:processor.py:167 Added loop detection middleware
INFO     src.core.services.backend_service:backend_service.py:107 Determined default_backend: mock
INFO     src.core.services.backend_service:backend_service.py:113 Result of parse_model_backend: (mock, claude-3-opus-20240229)
INFO     src.core.services.backend_service:backend_service.py:119 Final effective_model=claude-3-opus-20240229, backend_type=mock
INFO     src.core.services.backend_service:backend_service.py:136 Effective failover routes for request: []
INFO     src.core.services.backend_service:backend_service.py:140 Request.extra_body keys: ['model', 'messages', 'temperature', 'top_p', 'n', 'stream', 'stop', 'max_tokens', 'presence_penalty', 'frequency_penalty', 'logit_bias', 'user', 'tools', 'tool_choice', 'session_id', 'extra_body', 'reasoning_effort', 'reasoning', 'thinking_budget', 'generation_config']
INFO     src.core.services.backend_service:backend_service.py:144 Effective_model=claude-3-opus-20240229, backend_type=mock
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     src.anthropic_router:anthropic_router.py:124 OpenAI response type: <class 'src.core.domain.responses.ResponseEnvelope'>
INFO     src.anthropic_router:anthropic_router.py:125 FastAPI response type: <class 'starlette.responses.JSONResponse'>
INFO     src.anthropic_router:anthropic_router.py:126 FastAPI response headers: MutableHeaders({'content-type': 'application/json', 'content-length': '249'})
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/anthropic/v1/messages "HTTP/1.1 200 OK"
---------------------------- Captured log teardown ----------------------------
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
______________________ test_invalid_model_noninteractive ______________________

mock_call_completion = <SmartAsyncMock name='call_completion' id='2190110870352'>
client = <starlette.testclient.TestClient object at 0x000001FDECE11330>

    @patch(
        "src.core.services.backend_service.BackendService.call_completion",
        new_callable=AsyncMock,
    )
    def test_invalid_model_noninteractive(mock_call_completion: Any, client: Any) -> None:
        from src.core.common.exceptions import InvalidRequestError
    
        # For the first call (command processing), return a normal response
        mock_call_completion.side_effect = [
            ResponseEnvelope(
                content={
                    "id": "cmd-1",
                    "choices": [
                        {
                            "message": {
                                "content": "Model 'bad' not found for backend 'openrouter'"
                            }
                        }
                    ],
                },
                headers={"Content-Type": "application/json"},
                status_code=200,
            ),
            # For the second call, raise an error
            InvalidRequestError(message="Model 'bad' not found for backend 'openrouter'"),
        ]
    
        # First request: set an invalid model
        payload = {
            "model": "m",
            "messages": [{"role": "user", "content": "!/set(model=openrouter:bad)"}],
        }
        resp = client.post("/v1/chat/completions", json=payload)
        assert resp.status_code == 200
        content = resp.json()["choices"][0]["message"]["content"]
        # The command might succeed even with invalid model in the new architecture
>       assert "Model" in content and "bad" in content
E       AssertionError: assert ('Model' in 'Mock response from test backend')

tests\unit\chat_completions_tests\test_error_handling.py:112: AssertionError
---------------------------- Captured stdout setup ----------------------------
SKIPPING global mock for test: test_invalid_model_noninteractive in module: tests.unit.chat_completions_tests.test_error_handling
2025-08-20 19:01:04 [info     ] API Key authentication is disabled
----------------------------- Captured log setup ------------------------------
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: MockBackendStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.test_stages:test_stages.py:43 Initializing mock backend services...
DEBUG    src.core.app.stages.test_stages:test_stages.py:87 Registered mock backend config provider
DEBUG    src.core.app.stages.test_stages:test_stages.py:345 Registered mock backend factory
DEBUG    src.core.app.stages.test_stages:test_stages.py:310 Registered mock backend service with full method coverage
DEBUG    src.core.app.stages.test_stages:test_stages.py:427 Overrode session service to ensure real Session objects
INFO     src.core.app.stages.test_stages:test_stages.py:60 Mock backend services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 12 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
------------------------------ Captured log call ------------------------------
DEBUG    src.core.app.stages.processor:processor.py:167 Added loop detection middleware
INFO     src.core.app.controllers.chat_controller:chat_controller.py:68 Handling chat completion request: model=m
INFO     src.core.app.stages.test_stages:test_stages.py:171 Mock backend returning JSON response for model: mock-model
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/chat/completions "HTTP/1.1 200 OK"
---------------------------- Captured log teardown ----------------------------
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
___________________________ test_rate_limit_memory ____________________________

httpx_mock_client = <starlette.testclient.TestClient object at 0x000001FDECC49AE0>
httpx_mock = <pytest_httpx._httpx_mock.HTTPXMock object at 0x000001FDECCB32B0>

    @pytest.mark.httpx_mock(assert_all_responses_were_requested=False, assert_all_requests_were_expected=False)
    def test_rate_limit_memory(
        httpx_mock_client, httpx_mock: HTTPXMock
    ):  # Use custom client fixture
        httpx_mock.non_mocked_hosts = []  # Mock all hosts
    
        httpx_mock.add_response(
            url="https://api.openai.com/v1/models", json={"data": [{"id": "dummy"}]}
        )
    
        # Add multiple OpenAI responses to handle multiple calls
        httpx_mock.add_response(
            url="https://api.openai.com/v1/chat/completions",
            method="POST",
            status_code=200,
            json={"choices": [{"message": {"content": "mocked openai response"}}]},
        )
    
        # Add another OpenAI response for the second call
        httpx_mock.add_response(
            url="https://api.openai.com/v1/chat/completions",
            method="POST",
            status_code=200,
            json={"choices": [{"message": {"content": "mocked openai response"}}]},
        )
    
        error_detail = {
            "error": {
                "code": 429,
                "message": "quota exceeded",
                "status": "RESOURCE_EXHAUSTED",
                "details": [
                    {
                        "@type": "type.googleapis.com/google.rpc.RetryInfo",
                        "retryDelay": "1s",
                    }
                ],
            }
        }
    
        # Mock the Gemini responses using a callback to handle multiple requests
        httpx_mock.add_response(
            url=re.compile(
                r"https://generativelanguage.googleapis.com/v1beta/models/gemini-1:generateContent.*"
            ),
            method="POST",
            status_code=429,
            json=error_detail,
        )
        httpx_mock.add_response(
            url=re.compile(
                r"https://generativelanguage.googleapis.com/v1beta/models/gemini-1:generateContent.*"
            ),
            method="POST",
            status_code=200,
            json={
                "candidates": [{"content": {"parts": [{"text": "ok"}]}}],
                "usageMetadata": {
                    "promptTokenCount": 0,
                    "candidatesTokenCount": 0,
                    "totalTokenCount": 0,
                },
            },
        )
    
        # Use a command to set the backend to gemini
        set_backend_payload = {
            "model": "some-model",
            "messages": [{"role": "user", "content": "!/set(backend=gemini)"}],
        }
        httpx_mock_client.post("/v1/chat/completions", json=set_backend_payload)
    
        payload = {"model": "gemini-1", "messages": [{"role": "user", "content": "hi"}]}
        r1 = httpx_mock_client.post("/v1/chat/completions", json=payload)
        # The test may fail before using all mocks, so only assert if successful
        if r1.status_code == 200:
            try:
                response_json = r1.json()
                # If we can parse the JSON and it's a dict, check the structure
                if isinstance(response_json, dict) and "choices" in response_json:
>                   assert response_json["choices"][0]["message"]["content"].endswith("ok")
E                   AssertionError: assert False
E                    +  where False = <built-in method endswith of str object at 0x000001FDEDE89D40>('ok')
E                    +    where <built-in method endswith of str object at 0x000001FDEDE89D40> = 'mocked openai response'.endswith

tests\unit\chat_completions_tests\test_rate_limiting.py:99: AssertionError
---------------------------- Captured stdout setup ----------------------------
SKIPPING global mock for test: test_rate_limit_memory in module: tests.unit.chat_completions_tests.test_rate_limiting
2025-08-20 19:01:06 [info     ] API Key authentication is disabled
----------------------------- Captured log setup ------------------------------
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: RealBackendTestStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.test_stages:test_stages.py:523 Initializing real backend services for HTTP mocking tests...
INFO     src.core.app.stages.backend:backend.py:52 Initializing backend services...
DEBUG    src.core.app.stages.backend:backend.py:57 Imported connectors, registered backends: ['gemini', 'openai', 'openrouter', 'qwen-oauth', 'zai']
DEBUG    src.core.app.stages.backend:backend.py:88 Registered backend registry instance
DEBUG    src.core.app.stages.backend:backend.py:116 Registered backend factory with dependencies
DEBUG    src.core.app.stages.backend:backend.py:141 Registered backend config provider
DEBUG    src.core.app.stages.backend:backend.py:189 Registered backend service with all dependencies
INFO     src.core.app.stages.backend:backend.py:75 Backend services initialized successfully
DEBUG    src.core.app.stages.test_stages:test_stages.py:567 Overrode session service to ensure real Session objects
INFO     src.core.app.stages.test_stages:test_stages.py:535 Real backend services for HTTP mocking initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 13 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
---------------------------- Captured stdout call -----------------------------
2025-08-20 19:01:06 [debug    ] Initialized failover service   failover_routes={}
------------------------------ Captured log call ------------------------------
DEBUG    src.core.app.stages.processor:processor.py:167 Added loop detection middleware
INFO     src.core.app.controllers.chat_controller:chat_controller.py:68 Handling chat completion request: model=some-model
INFO     src.core.services.backend_service:backend_service.py:107 Determined default_backend: openai
INFO     src.core.services.backend_service:backend_service.py:113 Result of parse_model_backend: (openai, some-model)
INFO     src.core.services.backend_service:backend_service.py:119 Final effective_model=some-model, backend_type=openai
INFO     src.core.services.backend_service:backend_service.py:136 Effective failover routes for request: []
INFO     src.core.services.backend_service:backend_service.py:140 Request.extra_body keys: ['model', 'messages', 'temperature', 'top_p', 'n', 'stream', 'stop', 'max_tokens', 'presence_penalty', 'frequency_penalty', 'logit_bias', 'user', 'tools', 'tool_choice', 'session_id', 'extra_body', 'reasoning_effort', 'reasoning', 'thinking_budget', 'generation_config']
INFO     src.core.services.backend_service:backend_service.py:144 Effective_model=some-model, backend_type=openai
INFO     src.core.services.backend_factory:backend_factory.py:114 Factory initializing backend openai with {'api_key': '***'}
INFO     src.connectors.openai:openai.py:48 OpenAIConnector initialize called. api_key: ***
INFO     httpx:_client.py:1740 HTTP Request: GET https://api.openai.com/v1/models "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/chat/completions "HTTP/1.1 200 OK"
INFO     src.core.app.controllers.chat_controller:chat_controller.py:68 Handling chat completion request: model=gemini-1
INFO     src.core.services.backend_service:backend_service.py:107 Determined default_backend: openai
INFO     src.core.services.backend_service:backend_service.py:113 Result of parse_model_backend: (openai, gemini-1)
INFO     src.core.services.backend_service:backend_service.py:119 Final effective_model=gemini-1, backend_type=openai
INFO     src.core.services.backend_service:backend_service.py:136 Effective failover routes for request: []
INFO     src.core.services.backend_service:backend_service.py:140 Request.extra_body keys: ['model', 'messages', 'temperature', 'top_p', 'n', 'stream', 'stop', 'max_tokens', 'presence_penalty', 'frequency_penalty', 'logit_bias', 'user', 'tools', 'tool_choice', 'session_id', 'extra_body', 'reasoning_effort', 'reasoning', 'thinking_budget', 'generation_config']
INFO     src.core.services.backend_service:backend_service.py:144 Effective_model=gemini-1, backend_type=openai
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/chat/completions "HTTP/1.1 200 OK"
---------------------------- Captured log teardown ----------------------------
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
============================== warnings summary ===============================
dev\test_api_key_redaction.py:51
  C:\Users\Mateusz\source\repos\llm-interactive-proxy\dev\test_api_key_redaction.py:51: PytestCollectionWarning: cannot collect test class 'TestLogHandler' because it has a __init__ constructor (from: dev/test_api_key_redaction.py)
    class TestLogHandler(logging.Handler):

src\core\app\test_builder.py:35
  C:\Users\Mateusz\source\repos\llm-interactive-proxy\src\core\app\test_builder.py:35: PytestCollectionWarning: cannot collect test class 'ApplicationTestBuilder' because it has a __init__ constructor (from: src/core/app/test_builder.py)
    class ApplicationTestBuilder(ApplicationBuilder):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_endpoint_with_auth
FAILED tests/integration/test_new_architecture.py::test_anthropic_endpoint - ...
FAILED tests/unit/chat_completions_tests/test_error_handling.py::test_invalid_model_noninteractive
FAILED tests/unit/chat_completions_tests/test_rate_limiting.py::test_rate_limit_memory
==== 4 failed, 737 passed, 80 skipped, 43 deselected, 2 warnings in 28.21s ====
