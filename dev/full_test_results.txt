============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\Mateusz\source\repos\llm-interactive-proxy\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\Mateusz\source\repos\llm-interactive-proxy
configfile: pyproject.toml
plugins: anyio-4.10.0, asyncio-1.1.0, cov-6.2.1, httpx-0.35.0, mock-3.14.1, snapshot-0.9.0, respx-0.22.0
asyncio: mode=auto, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 864 items / 43 deselected / 821 selected

dev/test_api_key_redaction.py::test_key_discovery PASSED                 [  0%]
dev/test_api_key_redaction.py::test_log_redaction PASSED                 [  0%]
tests/chat_completions_tests/test_anthropic_api_compatibility.py::test_anthropic_messages_non_streaming PASSED [  0%]
tests/chat_completions_tests/test_anthropic_api_compatibility.py::test_anthropic_messages_with_tool_use_from_openai_tool_calls PASSED [  0%]
tests/chat_completions_tests/test_anthropic_frontend.py::test_anthropic_messages_non_streaming_frontend PASSED [  0%]
tests/chat_completions_tests/test_anthropic_frontend.py::test_anthropic_messages_streaming_frontend PASSED [  0%]
tests/chat_completions_tests/test_anthropic_frontend.py::test_anthropic_messages_auth_failure PASSED [  0%]
tests/chat_completions_tests/test_anthropic_frontend.py::test_models_endpoint_includes_anthropic PASSED [  0%]
tests/integration/commands/loop_detection_commands/test_integration_loop_detection_command.py::test_loop_detection_enable_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_loop_detection_command.py::test_loop_detection_disable_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_loop_detection_command.py::test_loop_detection_default_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_detection_command.py::test_tool_loop_detection_enable_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_detection_command.py::test_tool_loop_detection_disable_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_detection_command.py::test_tool_loop_detection_default_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_max_repeats_command.py::test_max_repeats_success_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_max_repeats_command.py::test_max_repeats_failure_snapshot SKIPPED [  1%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_mode_command.py::test_tool_loop_mode_success_snapshot SKIPPED [  2%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_mode_command.py::test_tool_loop_mode_failure_snapshot SKIPPED [  2%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_ttl_command.py::test_ttl_success_snapshot SKIPPED [  2%]
tests/integration/commands/loop_detection_commands/test_integration_tool_loop_ttl_command.py::test_ttl_failure_snapshot SKIPPED [  2%]
tests/integration/commands/test_integration_failover_commands.py::test_failover_commands_lifecycle SKIPPED [  2%]
tests/integration/commands/test_integration_hello_command.py::test_hello_snapshot PASSED [  2%]
tests/integration/commands/test_integration_help_command.py::test_help_general_snapshot PASSED [  2%]
tests/integration/commands/test_integration_help_command.py::test_help_specific_command_snapshot PASSED [  2%]
tests/integration/commands/test_integration_help_command.py::test_help_unknown_command_snapshot PASSED [  3%]
tests/integration/commands/test_integration_model_command.py::test_set_model_snapshot PASSED [  3%]
tests/integration/commands/test_integration_model_command.py::test_set_model_with_backend_snapshot PASSED [  3%]
tests/integration/commands/test_integration_model_command.py::test_unset_model_snapshot PASSED [  3%]
tests/integration/commands/test_integration_oneoff_command.py::test_oneoff_success_snapshot PASSED [  3%]
tests/integration/commands/test_integration_oneoff_command.py::test_oneoff_failure_snapshot PASSED [  3%]
tests/integration/commands/test_integration_project_command.py::test_project_success_snapshot PASSED [  3%]
tests/integration/commands/test_integration_project_command.py::test_project_failure_snapshot PASSED [  3%]
tests/integration/commands/test_integration_pwd_command.py::test_pwd_with_dir_set_snapshot PASSED [  4%]
tests/integration/commands/test_integration_pwd_command.py::test_pwd_with_dir_not_set_snapshot PASSED [  4%]
tests/integration/commands/test_integration_set_command.py::test_set_temperature_integration PASSED [  4%]
tests/integration/commands/test_integration_set_command.py::test_set_backend_and_model_integration PASSED [  4%]
tests/integration/commands/test_integration_temperature_command.py::test_temperature_success_snapshot PASSED [  4%]
tests/integration/commands/test_integration_temperature_command.py::test_temperature_failure_snapshot PASSED [  4%]
tests/integration/commands/test_integration_unset_command.py::test_unset_temperature_snapshot PASSED [  4%]
tests/integration/commands/test_integration_unset_command.py::test_unset_model_snapshot PASSED [  4%]
tests/integration/commands/test_integration_unset_command.py::test_unset_multiple_params_snapshot PASSED [  4%]
tests/integration/commands/test_integration_unset_command.py::test_unset_unknown_param_snapshot PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_anthropic_sdk_client_creation PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_async_anthropic_sdk_client_creation PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_models_endpoint_via_http PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_messages_endpoint_validation_via_http PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_messages_endpoint_with_system_message PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_messages_endpoint_streaming_request PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_messages_endpoint_with_stop_sequences PASSED [  5%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_conversation_flow_via_http PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_error_handling_invalid_model PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_error_handling_missing_required_fields PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_parameter_validation_ranges PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_health_and_info_endpoints PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_anthropic_sdk_models_call_mock PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_concurrent_requests PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_large_payload_handling PASSED [  6%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_unicode_and_special_characters PASSED [  7%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_content_type_headers PASSED [  7%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_anthropic_specific_model_names PASSED [  7%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_endpoint_not_found PASSED [  7%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendIntegration::test_method_not_allowed PASSED [  7%]
tests/integration/test_anthropic_frontend_integration.py::TestAnthropicFrontendWithoutSDK::test_endpoints_work_without_sdk SKIPPED [  7%]
tests/integration/test_app.py::test_chat_completions_endpoint_handler_setup PASSED [  7%]
tests/integration/test_app.py::test_streaming_chat_completions_endpoint_handler_setup PASSED [  7%]
tests/integration/test_app.py::test_command_processing_handler_setup PASSED [  8%]
tests/integration/test_backend_probing.py::test_functional_backends_in_test_env PASSED [  8%]
tests/integration/test_backend_probing.py::test_backend_config_provider_in_di PASSED [  8%]
tests/integration/test_backend_probing.py::test_httpx_client_shared_in_di PASSED [  8%]
tests/integration/test_backend_probing.py::test_backend_factory_uses_shared_client PASSED [  8%]
tests/integration/test_backend_probing.py::test_backend_service_uses_backend_config_provider SKIPPED [  8%]
tests/integration/test_cline_tool_call_implementation.py::TestClineCommandResponses::test_cline_hello_command_returns_tool_calls SKIPPED [  8%]
tests/integration/test_cline_tool_call_implementation.py::TestClineCommandResponses::test_cline_set_command_returns_tool_calls SKIPPED [  8%]
tests/integration/test_cline_tool_call_implementation.py::TestClineBackendResponses::test_xml_content_converted_to_tool_calls SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestClineBackendResponses::test_backend_response_transformation_logic SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestNonClineAgents::test_non_cline_agents_receive_regular_content SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestNonClineAgents::test_xml_content_not_converted_for_non_cline SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestFrontendAgnostic::test_openai_frontend_detection SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestFrontendAgnostic::test_anthropic_frontend_detection SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestFrontendAgnostic::test_gemini_frontend_detection SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestToolCallStructure::test_tool_call_format_compliance SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestToolCallStructure::test_tool_call_id_uniqueness SKIPPED [  9%]
tests/integration/test_cline_tool_call_implementation.py::TestEndToEndScenarios::test_cline_workflow_with_commands SKIPPED [ 10%]
tests/integration/test_cline_tool_call_implementation.py::TestEndToEndScenarios::test_mixed_agent_session SKIPPED [ 10%]
tests/integration/test_direct_controllers.py::test_chat_controller PASSED [ 10%]
tests/integration/test_direct_controllers.py::test_chat_controller_error_handling PASSED [ 10%]
tests/integration/test_direct_controllers.py::test_anthropic_controller PASSED [ 10%]
tests/integration/test_direct_controllers.py::test_anthropic_controller_error_handling PASSED [ 10%]
tests/integration/test_end_to_end_loop_detection.py::test_loop_detection_with_mocked_backend SKIPPED [ 10%]
tests/integration/test_end_to_end_loop_detection.py::test_loop_detection_in_streaming_response SKIPPED [ 10%]
tests/integration/test_end_to_end_loop_detection.py::test_loop_detection_integration_with_middleware_chain SKIPPED [ 11%]
tests/integration/test_end_to_end_loop_detection.py::test_request_processor_uses_response_processor SKIPPED [ 11%]
tests/integration/test_failover_routes.py::test_failover_route_commands SKIPPED [ 11%]
tests/integration/test_failover_routes.py::test_failover_service_routes PASSED [ 11%]
tests/integration/test_failover_routes.py::test_backend_service_failover PASSED [ 11%]
tests/integration/test_hello_command_integration.py::test_hello_command_integration PASSED [ 11%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_endpoint_no_auth PASSED [ 11%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_v1_models_endpoint_no_auth PASSED [ 11%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_endpoint_with_auth FAILED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_endpoint_invalid_auth SKIPPED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_with_configured_backends PASSED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_format_compliance PASSED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_endpoint_error_handling PASSED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsDiscovery::test_discover_openai_models PASSED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsDiscovery::test_discover_anthropic_models PASSED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsDiscovery::test_discover_models_with_failover PASSED [ 12%]
tests/integration/test_models_endpoints.py::TestModelsEndpointIntegration::test_full_models_discovery_flow PASSED [ 13%]
tests/integration/test_models_endpoints.py::TestModelsEndpointIntegration::test_models_caching_behavior PASSED [ 13%]
tests/integration/test_models_endpoints.py::TestModelsEndpointIntegration::test_models_endpoint_performance PASSED [ 13%]
tests/integration/test_models_endpoints.py::TestModelsEndpointIntegration::test_both_endpoints_return_same_data[/models] PASSED [ 13%]
tests/integration/test_models_endpoints.py::TestModelsEndpointIntegration::test_both_endpoints_return_same_data[/v1/models] PASSED [ 13%]
tests/integration/test_multimodal_integration.py::TestMultimodalIntegration::test_openai_multimodal_conversion PASSED [ 13%]
tests/integration/test_multimodal_integration.py::TestMultimodalIntegration::test_anthropic_multimodal_conversion PASSED [ 13%]
tests/integration/test_multimodal_integration.py::TestMultimodalIntegration::test_gemini_multimodal_conversion PASSED [ 13%]
tests/integration/test_multimodal_integration.py::TestMultimodalIntegration::test_legacy_compatibility PASSED [ 14%]
tests/integration/test_multimodal_integration.py::TestMultimodalIntegration::test_complex_multimodal_message PASSED [ 14%]
tests/integration/test_multimodal_integration.py::TestMultimodalIntegration::test_mixed_content_types PASSED [ 14%]
tests/integration/test_new_architecture.py::test_app_has_service_provider PASSED [ 14%]
tests/integration/test_new_architecture.py::test_service_provider_has_required_services PASSED [ 14%]
tests/integration/test_new_architecture.py::test_chat_completion_endpoint PASSED [ 14%]
tests/integration/test_new_architecture.py::test_command_processing PASSED [ 14%]
tests/integration/test_new_architecture.py::test_streaming_response PASSED [ 14%]
tests/integration/test_new_architecture.py::test_anthropic_endpoint FAILED [ 14%]
tests/integration/test_oneoff_command_integration.py::test_oneoff_command_integration PASSED [ 15%]
tests/integration/test_oneoff_commands_minimal.py::test_oneoff_command_parsing PASSED [ 15%]
tests/integration/test_oneoff_commands_minimal.py::test_oneoff_command_execution PASSED [ 15%]
tests/integration/test_oneoff_commands_minimal.py::test_oneoff_command_invalid_format PASSED [ 15%]
tests/integration/test_oneoff_commands_minimal.py::test_oneoff_command_missing_argument PASSED [ 15%]
tests/integration/test_phase1_integration.py::test_integration_bridge_initialization PASSED [ 15%]
tests/integration/test_phase1_integration.py::test_hybrid_endpoints_available PASSED [ 15%]
tests/integration/test_phase1_integration.py::test_legacy_endpoints_still_work PASSED [ 15%]
tests/integration/test_phase1_integration.py::test_feature_flags_environment PASSED [ 16%]
tests/integration/test_phase1_integration.py::test_integration_bridge_async_initialization PASSED [ 16%]
tests/integration/test_phase1_integration.py::test_adapter_creation PASSED [ 16%]
tests/integration/test_pwd_command_integration.py::test_pwd_command_integration_with_project_dir PASSED [ 16%]
tests/integration/test_pwd_command_integration.py::test_pwd_command_integration_without_project_dir PASSED [ 16%]
tests/integration/test_real_world_loop_detection.py::TestRealWorldLoopDetection::test_example1_kiro_loop_detection PASSED [ 16%]
tests/integration/test_real_world_loop_detection.py::TestRealWorldLoopDetection::test_example2_platinum_futures_loop_detection PASSED [ 16%]
tests/integration/test_real_world_loop_detection.py::TestRealWorldLoopDetection::test_example3_no_loop_false_positive_check PASSED [ 16%]
tests/integration/test_real_world_loop_detection.py::TestRealWorldLoopDetection::test_streaming_loop_detection_example1 PASSED [ 17%]
tests/integration/test_real_world_loop_detection.py::TestRealWorldLoopDetection::test_streaming_no_false_positive_example3 PASSED [ 17%]
tests/integration/test_real_world_loop_detection.py::TestRealWorldLoopDetection::test_unicode_character_counting PASSED [ 17%]
tests/integration/test_tool_call_loop_detection.py::TestToolCallLoopDetection::test_break_mode_blocks_repeated_tool_calls SKIPPED [ 17%]
tests/integration/test_tool_call_loop_detection.py::TestToolCallLoopDetection::test_chance_then_break_mode_transparent_retry_success SKIPPED [ 17%]
tests/integration/test_tool_call_loop_detection.py::TestToolCallLoopDetection::test_chance_then_break_mode_transparent_retry_fail SKIPPED [ 17%]
tests/integration/test_tool_call_loop_detection.py::TestToolCallLoopDetection::test_different_tool_calls_not_blocked SKIPPED [ 17%]
tests/integration/test_tool_call_loop_detection.py::TestToolCallLoopDetection::test_disabled_tool_call_loop_detection SKIPPED [ 17%]
tests/integration/test_tool_call_loop_detection.py::TestToolCallLoopDetection::test_session_override_takes_precedence SKIPPED [ 18%]
tests/integration/test_versioned_api.py::test_versioned_endpoint_exists PASSED [ 18%]
tests/integration/test_versioned_api.py::test_versioned_endpoint_with_backend_service PASSED [ 18%]
tests/integration/test_versioned_api.py::test_versioned_endpoint_with_commands PASSED [ 18%]
tests/integration/test_versioned_api.py::test_compatibility_endpoint PASSED [ 18%]
tests/regression/test_mock_backend_regression.py::TestMockBackendRegression::test_legacy_chat_completion PASSED [ 18%]
tests/regression/test_mock_backend_regression.py::TestMockBackendRegression::test_new_chat_completion PASSED [ 18%]
tests/regression/test_mock_backend_regression.py::TestMockBackendRegression::test_legacy_streaming_chat_completion PASSED [ 18%]
tests/regression/test_mock_backend_regression.py::TestMockBackendRegression::test_new_streaming_chat_completion PASSED [ 19%]
tests/regression/test_mock_backend_regression.py::TestMockBackendRegression::test_legacy_tool_calling PASSED [ 19%]
tests/regression/test_mock_backend_regression.py::TestMockBackendRegression::test_new_tool_calling PASSED [ 19%]
tests/test_enforcement_demo.py::test_problematic_session_mock PASSED     [ 19%]
tests/test_enforcement_demo.py::test_safe_session_usage PASSED           [ 19%]
tests/test_top_p_fix.py::test_top_p_fix_with_actual_request PASSED       [ 19%]
tests/unit/anthropic_connector_tests/test_domain_to_connector.py::test_chat_completions_basic_request PASSED [ 19%]
tests/unit/anthropic_connector_tests/test_domain_to_connector.py::test_chat_completions_with_system_message PASSED [ 19%]
tests/unit/anthropic_connector_tests/test_domain_to_connector.py::test_chat_completions_with_tools PASSED [ 19%]
tests/unit/anthropic_connector_tests/test_domain_to_connector.py::test_chat_completions_streaming PASSED [ 20%]
tests/unit/anthropic_connector_tests/test_domain_to_connector.py::test_list_models PASSED [ 20%]
tests/unit/anthropic_connector_tests/test_domain_to_connector.py::test_anthropic_error_handling PASSED [ 20%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_billing_info_from_headers_anthropic PASSED [ 20%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_billing_info_from_response_anthropic_dict PASSED [ 20%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_billing_info_from_response_anthropic_object PASSED [ 20%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_billing_info_from_response_anthropic_no_usage PASSED [ 20%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_anthropic_usage_from_dict PASSED [ 20%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_anthropic_usage_from_object PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_anthropic_usage_empty_response PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_anthropic_usage_invalid_response PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_extract_anthropic_usage_partial_data PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_billing_info_calls_extract_usage PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_billing_info_structure_anthropic PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_anthropic_vs_other_backends PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_streaming_response_billing PASSED [ 21%]
tests/unit/anthropic_frontend_tests/test_anthropic_accounting.py::TestAnthropicFrontendAccounting::test_cost_calculation_placeholder PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_anthropic_message_model PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_anthropic_messages_request_model PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_anthropic_to_openai_request_basic PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_anthropic_to_openai_request_with_system PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_anthropic_to_openai_request_with_parameters PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_openai_to_anthropic_response_basic PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_openai_stream_to_anthropic_stream_start PASSED [ 22%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_openai_stream_to_anthropic_stream_content PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_openai_stream_to_anthropic_stream_finish PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_openai_stream_to_anthropic_stream_invalid PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_map_finish_reason PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_get_anthropic_models PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_extract_anthropic_usage_dict PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_extract_anthropic_usage_object PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_extract_anthropic_usage_empty PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_converters.py::TestAnthropicConverters::test_conversation_flow PASSED [ 23%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_router_prefix PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_health_endpoint PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_info_endpoint PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_models_endpoint PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_anthropic_models_function PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_messages_endpoint_not_implemented PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_anthropic_messages_function_validation PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_messages_endpoint_validation_errors PASSED [ 24%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_messages_endpoint_optional_parameters PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_messages_endpoint_streaming_request PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_invalid_endpoints PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_wrong_http_methods PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_large_request_handling PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_unicode_content_handling PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_edge_case_parameters PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_models_endpoint_error_handling PASSED [ 25%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_cors_headers PASSED [ 26%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_content_type_headers PASSED [ 26%]
tests/unit/anthropic_frontend_tests/test_anthropic_router.py::TestAnthropicRouter::test_router_tags_and_metadata PASSED [ 26%]
tests/unit/chat_completions_tests/test_basic_proxying.py::test_basic_request_proxying_non_streaming PASSED [ 26%]
tests/unit/chat_completions_tests/test_basic_proxying.py::test_basic_request_proxying_streaming PASSED [ 26%]
tests/unit/chat_completions_tests/test_commands_disabled.py::test_commands_ignored PASSED [ 26%]
tests/unit/chat_completions_tests/test_error_handling.py::test_empty_messages_after_processing_no_commands_bad_request PASSED [ 26%]
tests/unit/chat_completions_tests/test_error_handling.py::test_get_openrouter_headers_no_api_key PASSED [ 26%]
tests/unit/chat_completions_tests/test_error_handling.py::test_invalid_model_noninteractive FAILED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiModelsEndpoint::test_list_models_gemini_format PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiModelsEndpoint::test_models_endpoint_auth_disabled PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiGenerateContent::test_generate_content_basic PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiGenerateContent::test_generate_content_with_system_instruction PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiGenerateContent::test_generate_content_error_handling PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiStreamGenerateContent::test_stream_generate_content PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiAuthentication::test_gemini_auth_with_api_key_header PASSED [ 27%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiAuthentication::test_gemini_auth_fallback_to_bearer PASSED [ 28%]
tests/unit/chat_completions_tests/test_gemini_api_compatibility.py::TestGeminiRequestConversion::test_complex_content_conversion PASSED [ 28%]
tests/unit/chat_completions_tests/test_multimodal_cross_protocol.py::test_openai_frontend_to_gemini_backend_multimodal PASSED [ 28%]
tests/unit/chat_completions_tests/test_multimodal_cross_protocol.py::test_gemini_frontend_to_openai_backend_multimodal SKIPPED [ 28%]
tests/unit/chat_completions_tests/test_rate_limit_wait.py::test_wait_for_rate_limited_backends SKIPPED [ 28%]
tests/unit/chat_completions_tests/test_rate_limiting.py::test_rate_limit_memory FAILED [ 28%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_real_cline_hello_response SKIPPED [ 28%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_cline_pure_hello_command SKIPPED [ 28%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_cline_no_session_id SKIPPED [ 28%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_cline_non_command_message SKIPPED [ 29%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_cline_first_message_hello SKIPPED [ 29%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_cline_first_message_with_detection SKIPPED [ 29%]
tests/unit/chat_completions_tests/test_real_cline_response.py::test_realistic_cline_hello_request SKIPPED [ 29%]
tests/unit/chat_completions_tests/test_session_history.py::test_session_records_proxy_and_backend_interactions SKIPPED [ 29%]
tests/unit/chat_completions_tests/test_session_history.py::test_session_records_streaming_placeholder SKIPPED [ 29%]
tests/unit/commands/loop_detection_commands/test_unit_loop_detection_command.py::test_loop_detection_enable SKIPPED [ 29%]
tests/unit/commands/loop_detection_commands/test_unit_loop_detection_command.py::test_loop_detection_disable SKIPPED [ 29%]
tests/unit/commands/loop_detection_commands/test_unit_loop_detection_command.py::test_loop_detection_default_enables SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_detection_command.py::test_tool_loop_detection_enable SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_detection_command.py::test_tool_loop_detection_disable SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_detection_command.py::test_tool_loop_detection_default_enables SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_max_repeats_command.py::test_max_repeats_success SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_max_repeats_command.py::test_max_repeats_failure_invalid_int SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_max_repeats_command.py::test_max_repeats_failure_too_low SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_max_repeats_command.py::test_max_repeats_failure_no_value SKIPPED [ 30%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_mode_command.py::test_tool_loop_mode_success[break] SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_mode_command.py::test_tool_loop_mode_success[chance_then_break] SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_mode_command.py::test_tool_loop_mode_failure_invalid SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_mode_command.py::test_tool_loop_mode_failure_no_mode SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_ttl_command.py::test_ttl_success SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_ttl_command.py::test_ttl_failure_invalid_int SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_ttl_command.py::test_ttl_failure_too_low SKIPPED [ 31%]
tests/unit/commands/loop_detection_commands/test_unit_tool_loop_ttl_command.py::test_ttl_failure_no_value SKIPPED [ 31%]
tests/unit/commands/test_set_command.py::test_handle_temperature_success PASSED [ 32%]
tests/unit/commands/test_set_command.py::test_handle_temperature_invalid_value PASSED [ 32%]
tests/unit/commands/test_set_command.py::test_handle_temperature_out_of_range PASSED [ 32%]
tests/unit/commands/test_set_command.py::test_handle_backend_and_model_set_backend PASSED [ 32%]
tests/unit/commands/test_set_command.py::test_handle_backend_and_model_set_model PASSED [ 32%]
tests/unit/commands/test_set_command.py::test_handle_backend_and_model_set_both PASSED [ 32%]
tests/unit/commands/test_set_command.py::test_handle_project_success PASSED [ 32%]
tests/unit/commands/test_unit_failover_commands.py::test_create_failover_route PASSED [ 32%]
tests/unit/commands/test_unit_failover_commands.py::test_delete_failover_route PASSED [ 33%]
tests/unit/commands/test_unit_failover_commands.py::test_list_failover_routes PASSED [ 33%]
tests/unit/commands/test_unit_help_command.py::test_help_general PASSED  [ 33%]
tests/unit/commands/test_unit_help_command.py::test_help_specific_command PASSED [ 33%]
tests/unit/commands/test_unit_help_command.py::test_help_unknown_command PASSED [ 33%]
tests/unit/commands/test_unit_model_command.py::test_set_model_simple PASSED [ 33%]
tests/unit/commands/test_unit_model_command.py::test_set_model_with_backend PASSED [ 33%]
tests/unit/commands/test_unit_model_command.py::test_unset_model PASSED  [ 33%]
tests/unit/commands/test_unit_oneoff_command.py::test_oneoff_success_slash_format PASSED [ 33%]
tests/unit/commands/test_unit_oneoff_command.py::test_oneoff_success_colon_format PASSED [ 34%]
tests/unit/commands/test_unit_oneoff_command.py::test_oneoff_failure_no_args PASSED [ 34%]
tests/unit/commands/test_unit_oneoff_command.py::test_oneoff_failure_invalid_format PASSED [ 34%]
tests/unit/commands/test_unit_project_command.py::test_project_command_success PASSED [ 34%]
tests/unit/commands/test_unit_project_command.py::test_project_command_failure_no_name PASSED [ 34%]
tests/unit/commands/test_unit_pwd_command.py::test_pwd_with_project_dir_set PASSED [ 34%]
tests/unit/commands/test_unit_pwd_command.py::test_pwd_with_project_dir_not_set PASSED [ 34%]
tests/unit/commands/test_unit_set_command.py::test_handle_temperature_success PASSED [ 34%]
tests/unit/commands/test_unit_set_command.py::test_handle_temperature_invalid_value PASSED [ 35%]
tests/unit/commands/test_unit_set_command.py::test_handle_temperature_out_of_range PASSED [ 35%]
tests/unit/commands/test_unit_set_command.py::test_handle_backend_and_model_set_backend PASSED [ 35%]
tests/unit/commands/test_unit_set_command.py::test_handle_backend_and_model_set_model PASSED [ 35%]
tests/unit/commands/test_unit_set_command.py::test_handle_backend_and_model_set_both PASSED [ 35%]
tests/unit/commands/test_unit_set_command.py::test_handle_project_success PASSED [ 35%]
tests/unit/commands/test_unit_set_command.py::test_handle_temperature_with_safe_session PASSED [ 35%]
tests/unit/commands/test_unit_temperature_command.py::test_temperature_success PASSED [ 35%]
tests/unit/commands/test_unit_temperature_command.py::test_temperature_failure_invalid_number PASSED [ 36%]
tests/unit/commands/test_unit_temperature_command.py::test_temperature_failure_out_of_range PASSED [ 36%]
tests/unit/commands/test_unit_temperature_command.py::test_temperature_failure_no_value PASSED [ 36%]
tests/unit/commands/test_unit_unset_command.py::test_unset_backend PASSED [ 36%]
tests/unit/commands/test_unit_unset_command.py::test_unset_model PASSED  [ 36%]
tests/unit/commands/test_unit_unset_command.py::test_unset_temperature PASSED [ 36%]
tests/unit/commands/test_unit_unset_command.py::test_unset_project PASSED [ 36%]
tests/unit/core/app/test_application_factory.py::TestApplicationBuilderServices::test_initialize_services_registers_all_required_services PASSED [ 36%]
tests/unit/core/app/test_application_factory.py::TestApplicationBuilderServices::test_initialize_services_handles_backend_registration PASSED [ 37%]
tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_loads_config FAILED [ 37%]
tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_creates_fastapi_app FAILED [ 37%]
tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_sets_up_app_state FAILED [ 37%]
tests/unit/core/app/test_application_factory.py::TestIntegration::test_app_handles_models_endpoint PASSED [ 37%]
tests/unit/core/app/test_application_factory.py::TestIntegration::test_app_dependency_injection_works PASSED [ 37%]
tests/unit/core/common/test_logging_utils.py::TestApiKeyRedactionFilter::test_init_with_keys PASSED [ 37%]
tests/unit/core/common/test_logging_utils.py::TestApiKeyRedactionFilter::test_init_without_keys PASSED [ 37%]
tests/unit/core/common/test_logging_utils.py::TestApiKeyRedactionFilter::test_sanitize_string PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestApiKeyRedactionFilter::test_sanitize_dict PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestApiKeyRedactionFilter::test_sanitize_list PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestApiKeyRedactionFilter::test_filter_log_record PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestDiscoverApiKeysFromConfigAndEnv::test_discover_from_env PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestDiscoverApiKeysFromConfigAndEnv::test_discover_from_config PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestInstallApiKeyRedactionFilter::test_install_filter PASSED [ 38%]
tests/unit/core/common/test_logging_utils.py::TestRedactText::test_redact_text PASSED [ 38%]
tests/unit/core/test_authentication.py::TestAPIKeyMiddleware::test_valid_bearer_key PASSED [ 38%]
tests/unit/core/test_authentication.py::TestAPIKeyMiddleware::test_valid_query_key PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAPIKeyMiddleware::test_invalid_key PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAPIKeyMiddleware::test_missing_key PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAPIKeyMiddleware::test_bypass_path PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAuthMiddleware::test_valid_token PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAuthMiddleware::test_invalid_token PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAuthMiddleware::test_missing_token PASSED [ 39%]
tests/unit/core/test_authentication.py::TestAuthMiddleware::test_bypass_path PASSED [ 39%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_api_key_auth_valid PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_api_key_auth_invalid PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_api_key_auth_missing PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_api_key_auth_query_param PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_api_key_auth_bypass_path PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_token_auth_valid PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_token_auth_invalid PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_token_auth_missing PASSED [ 40%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_token_auth_bypass_path PASSED [ 41%]
tests/unit/core/test_authentication.py::TestIntegratedAuthentication::test_no_auth PASSED [ 41%]
tests/unit/core/test_authentication.py::TestAppIntegration::test_app_with_auth_disabled PASSED [ 41%]
tests/unit/core/test_authentication.py::TestAppIntegration::test_app_with_auth_enabled PASSED [ 41%]
tests/unit/core/test_authentication.py::TestAppIntegration::test_app_with_auth_token PASSED [ 41%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_get_backend_config_with_attribute_access PASSED [ 41%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_get_backend_config_with_dict_access PASSED [ 41%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_get_backend_config_with_nonexistent_backend PASSED [ 41%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_get_backend_config_with_empty_backend PASSED [ 42%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_iter_backend_names PASSED [ 42%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_get_default_backend PASSED [ 42%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_get_default_backend_fallback PASSED [ 42%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_functional_backends PASSED [ 42%]
tests/unit/core/test_backend_config_provider.py::TestBackendConfigProvider::test_implements_interface PASSED [ 42%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_with_none_config PASSED [ 42%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_with_backend_config PASSED [ 42%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_test_env_injection PASSED [ 42%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_anthropic_specific PASSED [ 43%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_openrouter_specific PASSED [ 43%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_gemini_specific PASSED [ 43%]
tests/unit/core/test_backend_factory_ensure_backend.py::test_ensure_backend_custom_api_url_not_overridden PASSED [ 43%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendFactory::test_create_backend PASSED [ 43%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendFactory::test_initialize_backend PASSED [ 43%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendFactory::test_create_backend_invalid_type PASSED [ 43%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceBasic::test_get_or_create_backend_cached PASSED [ 43%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceBasic::test_get_or_create_backend_new PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceBasic::test_get_or_create_backend_error PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceBasic::test_prepare_messages SKIPPED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_basic PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_streaming PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_streaming_error PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_rate_limited PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_backend_error PASSED [ 44%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_invalid_response PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceCompletions::test_call_completion_invalid_streaming_response PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceValidation::test_validate_backend_and_model_valid PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceValidation::test_validate_backend_and_model_invalid_model PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceValidation::test_validate_backend_and_model_backend_error PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceFailover::test_simple_failover PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceFailover::test_complex_failover_first_attempt PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceFailover::test_complex_failover_second_attempt PASSED [ 45%]
tests/unit/core/test_backend_service_enhanced.py::TestBackendServiceFailover::test_complex_failover_all_fail PASSED [ 46%]
tests/unit/core/test_config.py::test_app_config_defaults PASSED          [ 46%]
tests/unit/core/test_config.py::test_app_config_validation PASSED        [ 46%]
tests/unit/core/test_config.py::test_app_config_to_legacy_config PASSED  [ 46%]
tests/unit/core/test_config.py::test_app_config_from_legacy_config PASSED [ 46%]
tests/unit/core/test_config.py::test_app_config_from_env PASSED          [ 46%]
tests/unit/core/test_config.py::test_load_config PASSED                  [ 46%]
tests/unit/core/test_config.py::test_load_config_debug PASSED            [ 46%]
tests/unit/core/test_configuration_interfaces.py::TestBackendConfigInterface::test_backend_config_implements_interface PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestBackendConfigInterface::test_backend_config_with_methods PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestBackendConfigInterface::test_backend_config_chaining PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestReasoningConfigInterface::test_reasoning_config_implements_interface PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestReasoningConfigInterface::test_reasoning_config_with_methods PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestReasoningConfigInterface::test_reasoning_config_chaining PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestLoopDetectionConfigInterface::test_loop_detection_config_implements_interface PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestLoopDetectionConfigInterface::test_loop_detection_config_with_methods PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestLoopDetectionConfigInterface::test_loop_detection_config_chaining PASSED [ 47%]
tests/unit/core/test_configuration_interfaces.py::TestConfigurationDefaults::test_backend_config_defaults PASSED [ 48%]
tests/unit/core/test_configuration_interfaces.py::TestConfigurationDefaults::test_reasoning_config_defaults PASSED [ 48%]
tests/unit/core/test_configuration_interfaces.py::TestConfigurationDefaults::test_loop_detection_config_defaults PASSED [ 48%]
tests/unit/core/test_configuration_interfaces.py::TestConfigurationImmutability::test_backend_config_immutability PASSED [ 48%]
tests/unit/core/test_configuration_interfaces.py::TestConfigurationImmutability::test_reasoning_config_immutability PASSED [ 48%]
tests/unit/core/test_configuration_interfaces.py::TestConfigurationImmutability::test_loop_detection_config_immutability PASSED [ 48%]
tests/unit/core/test_di_container.py::test_service_collection_singleton PASSED [ 48%]
tests/unit/core/test_di_container.py::test_service_collection_transient PASSED [ 48%]
tests/unit/core/test_di_container.py::test_service_collection_scoped PASSED [ 49%]
tests/unit/core/test_di_container.py::test_service_provider_get_required_service PASSED [ 49%]
tests/unit/core/test_di_container.py::test_service_factory PASSED        [ 49%]
tests/unit/core/test_di_container.py::test_service_with_dependency PASSED [ 49%]
tests/unit/core/test_domain_models.py::test_backend_config_immutability PASSED [ 49%]
tests/unit/core/test_domain_models.py::test_reasoning_config_immutability PASSED [ 49%]
tests/unit/core/test_domain_models.py::test_loop_detection_config_immutability PASSED [ 49%]
tests/unit/core/test_domain_models.py::test_session_state_immutability PASSED [ 49%]
tests/unit/core/test_domain_models.py::test_session_interaction_immutability PASSED [ 50%]
tests/unit/core/test_domain_models.py::test_session_mutability PASSED    [ 50%]
tests/unit/core/test_failover_service.py::test_get_failover_attempts PASSED [ 50%]
tests/unit/core/test_failover_service.py::test_get_failover_attempts_empty_route PASSED [ 50%]
tests/unit/core/test_failover_service.py::test_get_failover_attempts_invalid_element PASSED [ 50%]
tests/unit/core/test_hello_command.py::test_hello_command_execution PASSED [ 50%]
tests/unit/core/test_logging_utils.py::TestRedaction::test_redact PASSED [ 50%]
tests/unit/core/test_logging_utils.py::TestRedaction::test_redact_dict PASSED [ 50%]
tests/unit/core/test_logging_utils.py::TestRedaction::test_redact_text_with_secrets PASSED [ 51%]
tests/unit/core/test_logging_utils.py::TestLogging::test_get_logger PASSED [ 51%]
tests/unit/core/test_logging_utils.py::TestLogging::test_log_call PASSED [ 51%]
tests/unit/core/test_logging_utils.py::TestLogging::test_log_async_call PASSED [ 51%]
tests/unit/core/test_logging_utils.py::TestLogging::test_log_context PASSED [ 51%]
tests/unit/core/test_multimodal.py::TestContentPart::test_text_content_part PASSED [ 51%]
tests/unit/core/test_multimodal.py::TestContentPart::test_image_url_content_part PASSED [ 51%]
tests/unit/core/test_multimodal.py::TestContentPart::test_image_base64_content_part PASSED [ 51%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_dict PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_openai_format_text PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_openai_format_image_url PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_openai_format_image_base64 PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_anthropic_format_text PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_anthropic_format_image_url PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_anthropic_format_image_base64 PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_gemini_format_text PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestContentPart::test_to_gemini_format_image_base64 PASSED [ 52%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_text_message PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_with_image_message PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_is_multimodal PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_get_text_content PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_to_dict PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_to_legacy_format PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_to_legacy_format_no_text PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_to_openai_format PASSED [ 53%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_to_anthropic_format PASSED [ 54%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_to_gemini_format PASSED [ 54%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_from_legacy_message PASSED [ 54%]
tests/unit/core/test_multimodal.py::TestMultimodalMessage::test_backend_format_selection PASSED [ 54%]
tests/unit/core/test_request_processor.py::test_process_request_basic PASSED [ 54%]
tests/unit/core/test_request_processor.py::test_process_request_with_commands PASSED [ 54%]
tests/unit/core/test_request_processor.py::test_process_command_only_request PASSED [ 54%]
tests/unit/core/test_request_processor.py::test_process_streaming_request PASSED [ 54%]
tests/unit/core/test_request_processor.py::test_backend_error_handling PASSED [ 55%]
tests/unit/core/test_session_service.py::test_session_creation PASSED    [ 55%]
tests/unit/core/test_session_service.py::test_session_retrieval PASSED   [ 55%]
tests/unit/core/test_session_service.py::test_session_update PASSED      [ 55%]
tests/unit/core/test_session_service.py::test_session_deletion PASSED    [ 55%]
tests/unit/core/test_session_service.py::test_get_all_sessions PASSED    [ 55%]
tests/unit/gemini_connector_tests/test_http_error_streaming.py::test_chat_completions_http_error_streaming PASSED [ 55%]
tests/unit/gemini_connector_tests/test_model_prefix_handling.py::test_chat_completions_model_prefix_handled PASSED [ 55%]
tests/unit/gemini_connector_tests/test_multimodal_payload.py::test_multimodal_data_url_converts_to_inline_data PASSED [ 56%]
tests/unit/gemini_connector_tests/test_multimodal_payload.py::test_multimodal_http_url_converts_to_file_data PASSED [ 56%]
tests/unit/gemini_connector_tests/test_part_conversion.py::test_text_part_type_removed PASSED [ 56%]
tests/unit/gemini_connector_tests/test_part_conversion.py::test_system_message_filtered PASSED [ 56%]
tests/unit/gemini_connector_tests/test_streaming_success.py::test_chat_completions_streaming_success PASSED [ 56%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_added_to_generation_config PASSED [ 56%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_clamping_above_one PASSED [ 56%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_zero_value PASSED [ 56%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_with_existing_generation_config PASSED [ 57%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_with_thinking_budget PASSED [ 57%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_no_temperature_no_generation_config PASSED [ 57%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_with_extra_params_override PASSED [ 57%]
tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_streaming_request PASSED [ 57%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_detector_initialization PASSED [ 57%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_detector_disabled PASSED [ 57%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_simple_loop_detection PASSED [ 57%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_no_false_positive_normal_text PASSED [ 57%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_detector_reset PASSED [ 58%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_detector_enable_disable PASSED [ 58%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_detector_stats PASSED [ 58%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_minimum_content_threshold PASSED [ 58%]
tests/unit/loop_detection/test_detector.py::TestLoopDetector::test_config_validation PASSED [ 58%]
tests/unit/loop_detection/test_detector.py::TestLoopDetectionEvent::test_event_creation PASSED [ 58%]
tests/unit/loop_detection/test_streaming_wrapper.py::test_stream_cancellation_on_loop PASSED [ 58%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallSignature::test_from_tool_call_valid_json PASSED [ 58%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallSignature::test_from_tool_call_invalid_json PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallSignature::test_get_full_signature PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallSignature::test_is_expired PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_init PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_prune_expired_no_signatures PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_prune_expired_with_expired PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_disabled PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_first_call PASSED [ 59%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_different_calls PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_repeated_below_threshold PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_repeated_at_threshold_break_mode PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_repeated_at_threshold_chance_mode PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_after_chance_different_call PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_after_chance_same_call PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_reset_after_different PASSED [ 60%]
tests/unit/loop_detection/test_tool_call_tracker.py::TestToolCallTracker::test_track_tool_call_with_ttl_expiry PASSED [ 60%]
tests/unit/openai_connector_tests/test_integration.py::test_set_openai_url_command SKIPPED [ 61%]
tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_async_iterator FAILED [ 61%]
tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_sync_iterator FAILED [ 61%]
tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_coroutine FAILED [ 61%]
tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_error FAILED [ 61%]
tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_no_auth PASSED [ 61%]
tests/unit/openai_connector_tests/test_url_override.py::test_chat_completions_uses_default_url PASSED [ 61%]
tests/unit/openai_connector_tests/test_url_override.py::test_chat_completions_uses_custom_url PASSED [ 61%]
tests/unit/openai_connector_tests/test_url_override.py::test_initialize_with_custom_url PASSED [ 61%]
tests/unit/openrouter_connector_tests/test_headers_plumbing.py::test_headers_plumbing PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_http_error_non_streaming.py::test_chat_completions_http_error_non_streaming PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_http_error_streaming.py::test_chat_completions_http_error_streaming PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_non_streaming_success.py::test_chat_completions_non_streaming_success PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_headers_are_correct PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_payload_basic_fields_and_model PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_payload_message_count PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_payload_first_message_structure PASSED [ 62%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_payload_second_message_structure PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_payload_third_message_multipart_structure PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_payload_unset_fields_are_excluded PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_original_request_data_unmodified PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_payload_construction_and_headers.py::test_openrouter_processed_messages_remain_pydantic PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_request_error.py::test_chat_completions_request_error PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_streaming_success.py::test_chat_completions_streaming_success PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_added_to_payload PASSED [ 63%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_zero_value PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_max_value PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_with_extra_params PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_with_reasoning_effort PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_with_reasoning_config PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_no_temperature_not_in_payload PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_with_extra_params_override PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_streaming_request PASSED [ 64%]
tests/unit/openrouter_connector_tests/test_temperature_handling.py::TestOpenRouterTemperatureHandling::test_temperature_with_all_standard_params PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_valid_arguments PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_empty_arguments PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_arguments_with_slashes_in_model_name PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_arguments_single_argument PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_arguments_with_spaces PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_flag_argument PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_mixed_arguments PASSED [ 65%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_project_with_spaces_and_quotes PASSED [ 66%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_project_with_double_quotes PASSED [ 66%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_project_without_quotes PASSED [ 66%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_project_name_alias_quotes PASSED [ 66%]
tests/unit/proxy_logic_tests/test_parse_arguments.py::TestParseArguments::test_parse_project_name_alias_no_quotes PASSED [ 66%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_string_content_with_set_command PASSED [ 66%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_multimodal_content_with_command PASSED [ 66%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_command_strips_text_part_empty_in_multimodal PASSED [ 66%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_command_strips_message_to_empty_multimodal PASSED [ 66%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_command_in_earlier_message_not_processed_if_later_has_command PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_command_in_earlier_message_processed_if_later_has_no_command PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_no_commands_in_any_message PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_process_empty_messages_list PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_message_with_only_command_string_content PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_multimodal_text_part_preserved_if_empty_but_no_command_found PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_unknown_command_in_last_message PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_custom_command_prefix PASSED [ 67%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_multiline_command_detection PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_set_project_in_messages PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_unset_model_and_project_in_message PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_set_command_prefix_variants[$/] PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_set_command_prefix_variants['$/'] PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_set_command_prefix_variants["$/"] PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_unset_command_prefix PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_command_with_agent_environment_details PASSED [ 68%]
tests/unit/proxy_logic_tests/test_process_commands_in_messages.py::TestProcessCommandsInMessages::test_set_command_with_multiple_parameters_and_prefix PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_no_commands PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_model_command PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_model_command_with_slash PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unset_model_command PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_multiple_commands_in_one_string PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unknown_commands_are_preserved PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_command_at_start_of_string PASSED [ 69%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_command_at_end_of_string PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_command_only_string PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_malformed_set_command PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_malformed_unset_command PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_and_unset_project PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unset_model_and_project_together PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_interactive_mode PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unset_interactive_mode PASSED [ 70%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_hello_command PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_hello_command_with_text PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unknown_command_removed_interactive PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_invalid_model_interactive PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_invalid_model_noninteractive PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_backend PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unset_backend PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_set_redact_api_keys_flag PASSED [ 71%]
tests/unit/proxy_logic_tests/test_process_text_for_commands.py::TestProcessTextForCommands::test_unset_redact_api_keys_flag PASSED [ 71%]
tests/unit/test_agent_utils.py::test_detect_agent_cline PASSED           [ 72%]
tests/unit/test_agent_utils.py::test_detect_agent_roocode PASSED         [ 72%]
tests/unit/test_agent_utils.py::test_detect_agent_aider PASSED           [ 72%]
tests/unit/test_agent_utils.py::test_wrap_proxy_message_cline PASSED     [ 72%]
tests/unit/test_agent_utils.py::test_wrap_proxy_message_aider PASSED     [ 72%]
tests/unit/test_auth.py::test_auth_required PASSED                       [ 72%]
tests/unit/test_auth.py::test_auth_wrong_key PASSED                      [ 72%]
tests/unit/test_auth.py::test_disable_auth PASSED                        [ 72%]
tests/unit/test_auth.py::test_disable_auth_no_key_generated PASSED       [ 73%]
tests/unit/test_cli.py::test_apply_cli_args_sets_env PASSED              [ 73%]
tests/unit/test_cli.py::test_cli_interactive_mode PASSED                 [ 73%]
tests/unit/test_cli.py::test_cli_redaction_flag PASSED                   [ 73%]
tests/unit/test_cli.py::test_cli_force_set_project PASSED                [ 73%]
tests/unit/test_cli.py::test_cli_disable_interactive_commands PASSED     [ 73%]
tests/unit/test_cli.py::test_cli_log_argument PASSED                     [ 73%]
tests/unit/test_cli.py::test_main_log_file PASSED                        [ 73%]
tests/unit/test_cli.py::test_build_app_uses_env PASSED                   [ 74%]
tests/unit/test_cli.py::test_build_app_uses_interactive_env PASSED       [ 74%]
tests/unit/test_cli.py::test_default_command_prefix_from_env PASSED      [ 74%]
tests/unit/test_cli.py::test_invalid_command_prefix_cli[!] PASSED        [ 74%]
tests/unit/test_cli.py::test_invalid_command_prefix_cli[!!] PASSED       [ 74%]
tests/unit/test_cli.py::test_invalid_command_prefix_cli[prefix with space] PASSED [ 74%]
tests/unit/test_cli.py::test_invalid_command_prefix_cli[12345678901] PASSED [ 74%]
tests/unit/test_cli.py::test_check_privileges_root SKIPPED (Test for...) [ 74%]
tests/unit/test_cli.py::test_check_privileges_non_root SKIPPED (Test...) [ 75%]
tests/unit/test_cli.py::test_check_privileges_admin_windows PASSED       [ 75%]
tests/unit/test_cli.py::test_check_privileges_non_admin_windows PASSED   [ 75%]
tests/unit/test_cli.py::test_parse_cli_args_basic PASSED                 [ 75%]
tests/unit/test_cli.py::test_parse_cli_args_disable_auth PASSED          [ 75%]
tests/unit/test_cli.py::test_apply_cli_args_basic PASSED                 [ 75%]
tests/unit/test_cli.py::test_apply_cli_args_disable_auth_forces_localhost PASSED [ 75%]
tests/unit/test_cli.py::test_apply_cli_args_disable_auth_with_localhost_no_warning PASSED [ 75%]
tests/unit/test_cli.py::test_main_disable_auth_forces_localhost PASSED   [ 76%]
tests/unit/test_cli.py::test_main_disable_auth_with_localhost_no_force PASSED [ 76%]
tests/unit/test_cli.py::test_main_auth_enabled_allows_custom_host PASSED [ 76%]
tests/unit/test_command_parser_process_messages.py::test_process_messages_single_message_with_command[preserve_unknown_True] PASSED [ 76%]
tests/unit/test_command_parser_process_messages.py::test_process_messages_single_message_with_command[preserve_unknown_False] PASSED [ 76%]
tests/unit/test_command_parser_process_messages.py::test_process_messages_stops_after_first_command_in_message_content_list[preserve_unknown_True] PASSED [ 76%]
tests/unit/test_command_parser_process_messages.py::test_process_messages_stops_after_first_command_in_message_content_list[preserve_unknown_False] PASSED [ 76%]
tests/unit/test_command_parser_process_messages.py::test_process_messages_processes_command_in_last_message_and_stops[preserve_unknown_True] PASSED [ 76%]
tests/unit/test_command_parser_process_messages.py::test_process_messages_processes_command_in_last_message_and_stops[preserve_unknown_False] PASSED [ 76%]
tests/unit/test_command_parser_process_text.py::test_process_text_single_command[preserve_unknown_True] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_single_command[preserve_unknown_False] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_command_with_prefix_text[preserve_unknown_True] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_command_with_prefix_text[preserve_unknown_False] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_command_with_suffix_text[preserve_unknown_True] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_command_with_suffix_text[preserve_unknown_False] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_command_with_prefix_and_suffix_text[preserve_unknown_True] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_command_with_prefix_and_suffix_text[preserve_unknown_False] PASSED [ 77%]
tests/unit/test_command_parser_process_text.py::test_process_text_multiple_commands_only_first_processed[preserve_unknown_True] PASSED [ 78%]
tests/unit/test_command_parser_process_text.py::test_process_text_multiple_commands_only_first_processed[preserve_unknown_False] PASSED [ 78%]
tests/unit/test_command_parser_process_text.py::test_process_text_no_command[preserve_unknown_True] PASSED [ 78%]
tests/unit/test_command_parser_process_text.py::test_process_text_no_command[preserve_unknown_False] PASSED [ 78%]
tests/unit/test_command_parser_process_text.py::test_process_text_unknown_command[preserve_unknown_True] PASSED [ 78%]
tests/unit/test_command_parser_process_text.py::test_process_text_unknown_command[preserve_unknown_False] PASSED [ 78%]
tests/unit/test_config.py::test_collect_api_keys_single PASSED           [ 78%]
tests/unit/test_config.py::test_collect_api_keys_numbered PASSED         [ 78%]
tests/unit/test_config.py::test_collect_api_keys_prioritizes_numbered PASSED [ 79%]
tests/unit/test_config.py::test_load_config_basic PASSED                 [ 79%]
tests/unit/test_config.py::test_load_config_custom_values PASSED         [ 79%]
tests/unit/test_config.py::test_load_config_disable_auth_forces_localhost PASSED [ 79%]
tests/unit/test_config.py::test_load_config_disable_auth_with_localhost_no_warning PASSED [ 79%]
tests/unit/test_config.py::test_load_config_auth_enabled_allows_custom_host PASSED [ 79%]
tests/unit/test_config.py::test_load_config_str_to_bool_variations PASSED [ 79%]
tests/unit/test_config_persistence.py::test_save_and_load_persistent_config PASSED [ 79%]
tests/unit/test_config_persistence.py::test_invalid_persisted_backend PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_filter_initialization PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_basic_command_detection_and_removal PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_command_only_text PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_no_commands_present PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_different_command_prefixes PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_prefix_update PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_edge_cases PASSED [ 80%]
tests/unit/test_emergency_command_filter.py::TestProxyCommandFilter::test_complex_command_patterns PASSED [ 80%]
tests/unit/test_failover_routes.py::TestFailoverRoutes::test_create_route_enables_interactive PASSED [ 81%]
tests/unit/test_failover_routes.py::TestFailoverRoutes::test_route_append_and_list PASSED [ 81%]
tests/unit/test_failover_routes.py::TestFailoverRoutes::test_routes_are_server_wide PASSED [ 81%]
tests/unit/test_gemini_converters.py::TestMessageConversion::test_gemini_to_openai_simple_message PASSED [ 81%]
tests/unit/test_gemini_converters.py::TestMessageConversion::test_gemini_to_openai_model_role PASSED [ 81%]
tests/unit/test_gemini_converters.py::TestMessageConversion::test_gemini_to_openai_multiple_parts PASSED [ 81%]
tests/unit/test_gemini_converters.py::TestMessageConversion::test_openai_to_gemini_simple_message PASSED [ 81%]
tests/unit/test_gemini_converters.py::TestMessageConversion::test_openai_to_gemini_assistant_role PASSED [ 81%]
tests/unit/test_gemini_converters.py::TestMessageConversion::test_openai_to_gemini_system_role PASSED [ 82%]
tests/unit/test_get_command_pattern.py::test_get_command_pattern_default_prefix PASSED [ 82%]
tests/unit/test_get_command_pattern.py::test_get_command_pattern_custom_prefix PASSED [ 82%]
tests/unit/test_mock_backends.py::test_mock_backends_initialization PASSED [ 82%]
tests/unit/test_mock_backends.py::test_mock_backend_chat_completions PASSED [ 82%]
tests/unit/test_mock_backends.py::test_configure_mock_response PASSED    [ 82%]
tests/unit/test_mock_backends.py::test_configure_streaming_response PASSED [ 82%]
tests/unit/test_mock_backends.py::test_configure_error_response PASSED   [ 82%]
tests/unit/test_mock_backends.py::test_chat_completion_api_with_mock SKIPPED [ 83%]
tests/unit/test_mock_backends.py::test_mock_factory_fixture SKIPPED      [ 83%]
tests/unit/test_mock_backends.py::test_real_backend_fixture SKIPPED      [ 83%]
tests/unit/test_model_discovery.py::test_openrouter_models_cached PASSED [ 83%]
tests/unit/test_model_discovery.py::test_gemini_models_cached PASSED     [ 83%]
tests/unit/test_model_discovery.py::test_auto_default_backend PASSED     [ 83%]
tests/unit/test_model_discovery.py::test_multiple_backends_requires_arg PASSED [ 83%]
tests/unit/test_models_endpoint.py::test_models_endpoint_lists_all PASSED [ 83%]
tests/unit/test_models_endpoint.py::test_v1_models_endpoint_lists_all PASSED [ 84%]
tests/unit/test_no_prints.py::test_no_print_statements PASSED            [ 84%]
tests/unit/test_parse_arguments.py::test_parse_arguments_empty PASSED    [ 84%]
tests/unit/test_parse_arguments.py::test_parse_arguments_simple_key_value PASSED [ 84%]
tests/unit/test_parse_arguments.py::test_parse_arguments_multiple_key_values PASSED [ 84%]
tests/unit/test_parse_arguments.py::test_parse_arguments_boolean_true PASSED [ 84%]
tests/unit/test_parse_arguments.py::test_parse_arguments_mixed_values PASSED [ 84%]
tests/unit/test_parse_arguments.py::test_parse_arguments_quotes_stripping PASSED [ 84%]
tests/unit/test_prompt_redaction.py::test_redactor_replaces_keys_and_logs PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_valid_arguments PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_empty_arguments PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_arguments_with_slashes_in_model_name PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_arguments_single_argument PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_arguments_with_spaces PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_flag_argument PASSED [ 85%]
tests/unit/test_proxy_logic.py::TestParseArguments::test_parse_mixed_arguments PASSED [ 85%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_exact_expiry PASSED [ 85%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_before_expiry PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_flow_success PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_no_refresh_token PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_http_error PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_network_error PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_token_refresh_malformed_response PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_chat_completion_token_refresh_check PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_chat_completion_token_refresh_failure PASSED [ 86%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_persistence PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_persistence_error PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_loading_success PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_loading_file_not_found PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_loading_permission_error PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_loading_malformed_json PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_credential_loading_missing_access_token PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_get_headers_valid_token PASSED [ 87%]
tests/unit/test_qwen_oauth_authentication.py::TestQwenOAuthAuthentication::test_get_headers_no_token PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_connector_initialization PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_initialize_with_valid_credentials PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_initialize_without_credentials PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_initialize_with_invalid_credentials PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_access_token PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_access_token_no_credentials PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_endpoint_url_with_resource_url PASSED [ 88%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_endpoint_url_without_protocol PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_endpoint_url_default PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_is_token_expired_valid_token PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_is_token_expired_expired_token PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_is_token_expired_no_expiry PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_headers PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_headers_no_token PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_refresh_token_success PASSED [ 89%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_refresh_token_no_refresh_token PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_refresh_token_http_error PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_available_models_functional PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_get_available_models_not_functional PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_success FAILED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_with_prefix FAILED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_streaming PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_token_refresh_failure PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_exception_handling PASSED [ 90%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_save_oauth_credentials PASSED [ 91%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorEdgeCases::test_malformed_credentials_file PASSED [ 91%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorEdgeCases::test_credentials_file_permission_error PASSED [ 91%]
tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorEdgeCases::test_network_error_during_refresh PASSED [ 91%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_initialize_success PASSED [ 91%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_initialize_failure PASSED [ 91%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_get_endpoint_url_no_credentials PASSED [ 91%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_is_token_expired_no_credentials PASSED [ 91%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_is_token_expired_no_expiry_date PASSED [ 92%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_token_refresh_check_not_expired PASSED [ 92%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_chat_completions_generic_error_handling PASSED [ 92%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_model_prefix_stripping PASSED [ 92%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_http_exception_passthrough PASSED [ 92%]
tests/unit/test_qwen_oauth_enhanced_error_handling.py::TestQwenOAuthEnhancedErrorHandling::test_chat_completions_refresh_token_failure PASSED [ 92%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthInteractiveCommands::test_environment_variable_support PASSED [ 92%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthInteractiveCommands::test_cli_argument_support SKIPPED [ 92%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthInteractiveCommands::test_backend_attribute_name_conversion SKIPPED [ 93%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthInteractiveCommands::test_backend_object_accessibility SKIPPED [ 93%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthInteractiveCommands::test_functional_backends_includes_qwen_oauth PASSED [ 93%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthInteractiveCommands::test_backend_routing_with_qwen_oauth PASSED [ 93%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthConfigurationMethods::test_dotenv_file_support PASSED [ 93%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthConfigurationMethods::test_config_file_backend_persistence PASSED [ 93%]
tests/unit/test_qwen_oauth_interactive_commands.py::TestQwenOAuthConfigurationMethods::test_all_backend_access_methods SKIPPED [ 93%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_chat_completions_with_tools PASSED [ 93%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_chat_completions_tool_choice_none PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_chat_completions_specific_tool_choice PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_streaming_with_tool_calls PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_multi_turn_tool_conversation PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_tool_calling_error_handling PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling.py::TestQwenOAuthToolCallingUnit::test_tool_call_serialization PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_chat_completions_with_tools PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_chat_completions_tool_choice_none PASSED [ 94%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_chat_completions_specific_tool_choice PASSED [ 95%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_streaming_with_tool_calls PASSED [ 95%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_multi_turn_tool_conversation PASSED [ 95%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_tool_calling_error_handling PASSED [ 95%]
tests/unit/test_qwen_oauth_tool_calling_enhanced.py::TestQwenOAuthToolCallingEnhanced::test_model_prefix_stripping PASSED [ 95%]
tests/unit/test_rate_limit.py::test_parse_retry_delay_with_prefixed_string PASSED [ 95%]
tests/unit/test_rate_limit.py::test_rate_limit_registry_earliest PASSED  [ 95%]
tests/unit/test_response_shape.py::test_extract_response_content_with_dict PASSED [ 95%]
tests/unit/test_response_shape.py::test_extract_response_content_with_object_choices PASSED [ 95%]
tests/unit/test_security.py::test_cli_disable_auth_forces_localhost PASSED [ 96%]
tests/unit/test_security.py::test_env_disable_auth_forces_localhost PASSED [ 96%]
tests/unit/test_security.py::test_auth_enabled_allows_custom_host PASSED [ 96%]
tests/unit/test_security.py::test_config_disable_auth_forces_localhost PASSED [ 96%]
tests/unit/test_security.py::test_security_documentation PASSED          [ 96%]
tests/unit/test_session_manager.py::test_session_service_can_create_sessions PASSED [ 96%]
tests/unit/test_session_manager.py::test_session_creation_and_retrieval PASSED [ 96%]
tests/unit/test_session_manager.py::test_session_update_and_persistence PASSED [ 96%]
tests/unit/test_streaming_normalizer.py::TestStreamingContent::test_from_raw_bytes PASSED [ 97%]
tests/unit/test_streaming_normalizer.py::TestStreamingContent::test_from_raw_dict PASSED [ 97%]
tests/unit/test_streaming_normalizer.py::TestStreamingContent::test_from_raw_str PASSED [ 97%]
tests/unit/test_streaming_normalizer.py::TestStreamingContent::test_to_bytes PASSED [ 97%]
tests/unit/test_streaming_normalizer.py::TestStreamNormalizer::test_normalize_stream PASSED [ 97%]
tests/unit/test_streaming_normalizer.py::TestStreamNormalizer::test_process_stream_bytes_output PASSED [ 97%]
tests/unit/test_streaming_normalizer.py::TestStreamNormalizer::test_processor_transforms_content PASSED [ 97%]
tests/unit/test_tool_call_loop_middleware.py::test_process_no_context PASSED [ 97%]
tests/unit/test_tool_call_loop_middleware.py::test_process_no_config PASSED [ 98%]
tests/unit/test_tool_call_loop_middleware.py::test_process_disabled PASSED [ 98%]
tests/unit/test_tool_call_loop_middleware.py::test_process_no_tool_calls PASSED [ 98%]
tests/unit/test_tool_call_loop_middleware.py::test_process_with_tool_calls PASSED [ 98%]
tests/unit/test_tool_call_loop_middleware.py::test_reset_session PASSED  [ 98%]
tests/unit/test_tool_call_loop_middleware.py::test_different_tool_calls PASSED [ 98%]
tests/unit/test_transport_adapters.py::TestRequestAdapters::test_fastapi_to_domain_request_context PASSED [ 98%]
tests/unit/test_transport_adapters.py::TestResponseAdapters::test_to_fastapi_response_json PASSED [ 98%]
tests/unit/test_transport_adapters.py::TestResponseAdapters::test_to_fastapi_response_text PASSED [ 99%]
tests/unit/test_transport_adapters.py::TestResponseAdapters::test_to_fastapi_streaming_response PASSED [ 99%]
tests/unit/test_transport_adapters.py::TestResponseAdapters::test_domain_response_to_fastapi PASSED [ 99%]
tests/unit/test_transport_adapters.py::TestExceptionAdapters::test_map_domain_exception_to_http_exception PASSED [ 99%]
tests/unit/zai_connector_tests/test_domain_to_connector.py::test_chat_completions_basic_request PASSED [ 99%]
tests/unit/zai_connector_tests/test_domain_to_connector.py::test_chat_completions_with_tools PASSED [ 99%]
tests/unit/zai_connector_tests/test_domain_to_connector.py::test_chat_completions_streaming PASSED [ 99%]
tests/unit/zai_connector_tests/test_domain_to_connector.py::test_list_models PASSED [ 99%]
tests/unit/zai_connector_tests/test_domain_to_connector.py::test_default_models_fallback PASSED [100%]

================================== FAILURES ===================================
_____________ TestModelsEndpoints.test_models_endpoint_with_auth ______________

self = <tests.integration.test_models_endpoints.TestModelsEndpoints object at 0x000001F6F1040DF0>
app_with_auth_enabled = <fastapi.applications.FastAPI object at 0x000001F6F741AC20>

    def test_models_endpoint_with_auth(self, app_with_auth_enabled):
        """Test /models endpoint with authentication."""
        with TestClient(app_with_auth_enabled) as client:
            # Without auth - should fail
            response = client.get("/models")
            assert response.status_code == 401
    
            # With valid auth
            response = client.get(
                "/models", headers={"Authorization": "Bearer test-key-123"}
            )
>           assert response.status_code == 200
E           assert 401 == 200
E            +  where 401 = <Response [401 Unauthorized]>.status_code

tests\integration\test_models_endpoints.py:71: AssertionError
---------------------------- Captured stdout setup ----------------------------
SKIPPING global mock for test: test_models_endpoint_with_auth in module: tests.integration.test_models_endpoints
2025-08-20 18:57:05 [info     ] API Key authentication is enabled key_count=1
2025-08-20 18:57:05 [info     ] Auth token validation is enabled
----------------------------- Captured log setup ------------------------------
INFO     src.core.config.app_config:app_config.py:470 AppConfig.from_env - Determined default_backend: openai
INFO     src.core.config.app_config:app_config.py:544 Added test API key for default backend openai
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: MockBackendStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.test_stages:test_stages.py:43 Initializing mock backend services...
DEBUG    src.core.app.stages.test_stages:test_stages.py:87 Registered mock backend config provider
DEBUG    src.core.app.stages.test_stages:test_stages.py:345 Registered mock backend factory
DEBUG    src.core.app.stages.test_stages:test_stages.py:310 Registered mock backend service with full method coverage
DEBUG    src.core.app.stages.test_stages:test_stages.py:427 Overrode session service to ensure real Session objects
INFO     src.core.app.stages.test_stages:test_stages.py:60 Mock backend services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 13 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
------------------------------ Captured log call ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
WARNING  src.core.security.middleware:middleware.py:161 Invalid or missing auth token for GET /models from client testclient
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/models "HTTP/1.1 401 Unauthorized"
WARNING  src.core.security.middleware:middleware.py:161 Invalid or missing auth token for GET /models from client testclient
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/models "HTTP/1.1 401 Unauthorized"
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
___________________________ test_anthropic_endpoint ___________________________

client = <starlette.testclient.TestClient object at 0x000001F6F613D4B0>

    def test_anthropic_endpoint(client: TestClient) -> None:
        """Test that the Anthropic endpoint works."""
        # Create an Anthropic request
        request_data = {
            "model": "claude-3-opus-20240229",
            "messages": [{"role": "user", "content": "Hello, world!"}],
            "stream": False,
        }
    
        # Send the request
        response = client.post("/anthropic/v1/messages", json=request_data)
    
        # Check the response
        assert response.status_code == 200
        assert response.headers["content-type"] == "application/json"
    
        # Parse the response
        response_data = response.json()
    
        # Check the response data
        # The response is wrapped in a ResponseEnvelope
        assert "content" in response_data
        content = response_data["content"]
    
        # Check the content has the expected OpenAI format that's converted to Anthropic format
>       assert "id" in content
E       AssertionError: assert 'id' in [{'text': 'mock', 'type': 'text'}]

tests\integration\test_new_architecture.py:325: AssertionError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_anthropic_endpoint in module: tests.integration.test_new_architecture
2025-08-20 18:57:07 [info     ] API Key authentication is disabled
----------------------------- Captured log setup ------------------------------
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: BackendStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.backend:backend.py:52 Initializing backend services...
DEBUG    src.core.app.stages.backend:backend.py:57 Imported connectors, registered backends: ['gemini', 'openai', 'openrouter', 'qwen-oauth', 'zai']
DEBUG    src.core.app.stages.backend:backend.py:88 Registered backend registry instance
DEBUG    src.core.app.stages.backend:backend.py:116 Registered backend factory with dependencies
DEBUG    src.core.app.stages.backend:backend.py:141 Registered backend config provider
DEBUG    src.core.app.stages.backend:backend.py:189 Registered backend service with all dependencies
INFO     src.core.app.stages.backend:backend.py:75 Backend services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 11 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
---------------------------- Captured stdout call -----------------------------
2025-08-20 18:57:07 [debug    ] Initialized failover service   failover_routes={}
------------------------------ Captured log call ------------------------------
INFO     src.anthropic_router:anthropic_router.py:53 Anthropic messages request for model: claude-3-opus-20240229
DEBUG    src.core.app.stages.processor:processor.py:167 Added loop detection middleware
INFO     src.core.services.backend_service:backend_service.py:107 Determined default_backend: mock
INFO     src.core.services.backend_service:backend_service.py:113 Result of parse_model_backend: (mock, claude-3-opus-20240229)
INFO     src.core.services.backend_service:backend_service.py:119 Final effective_model=claude-3-opus-20240229, backend_type=mock
INFO     src.core.services.backend_service:backend_service.py:136 Effective failover routes for request: []
INFO     src.core.services.backend_service:backend_service.py:140 Request.extra_body keys: ['model', 'messages', 'temperature', 'top_p', 'n', 'stream', 'stop', 'max_tokens', 'presence_penalty', 'frequency_penalty', 'logit_bias', 'user', 'tools', 'tool_choice', 'session_id', 'extra_body', 'reasoning_effort', 'reasoning', 'thinking_budget', 'generation_config']
INFO     src.core.services.backend_service:backend_service.py:144 Effective_model=claude-3-opus-20240229, backend_type=mock
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     src.anthropic_router:anthropic_router.py:124 OpenAI response type: <class 'src.core.domain.responses.ResponseEnvelope'>
INFO     src.anthropic_router:anthropic_router.py:125 FastAPI response type: <class 'starlette.responses.JSONResponse'>
INFO     src.anthropic_router:anthropic_router.py:126 FastAPI response headers: MutableHeaders({'content-type': 'application/json', 'content-length': '249'})
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/anthropic/v1/messages "HTTP/1.1 200 OK"
---------------------------- Captured log teardown ----------------------------
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
______________________ test_invalid_model_noninteractive ______________________

mock_call_completion = <SmartAsyncMock name='call_completion' id='2160243840416'>
client = <starlette.testclient.TestClient object at 0x000001F6F89849A0>

    @patch(
        "src.core.services.backend_service.BackendService.call_completion",
        new_callable=AsyncMock,
    )
    def test_invalid_model_noninteractive(mock_call_completion: Any, client: Any) -> None:
        from src.core.common.exceptions import InvalidRequestError
    
        # For the first call (command processing), return a normal response
        mock_call_completion.side_effect = [
            ResponseEnvelope(
                content={
                    "id": "cmd-1",
                    "choices": [
                        {
                            "message": {
                                "content": "Model 'bad' not found for backend 'openrouter'"
                            }
                        }
                    ],
                },
                headers={"Content-Type": "application/json"},
                status_code=200,
            ),
            # For the second call, raise an error
            InvalidRequestError(message="Model 'bad' not found for backend 'openrouter'"),
        ]
    
        # First request: set an invalid model
        payload = {
            "model": "m",
            "messages": [{"role": "user", "content": "!/set(model=openrouter:bad)"}],
        }
        resp = client.post("/v1/chat/completions", json=payload)
        assert resp.status_code == 200
        content = resp.json()["choices"][0]["message"]["content"]
        # The command might succeed even with invalid model in the new architecture
>       assert "Model" in content and "bad" in content
E       AssertionError: assert ('Model' in 'Mock response from test backend')

tests\unit\chat_completions_tests\test_error_handling.py:112: AssertionError
---------------------------- Captured stdout setup ----------------------------
SKIPPING global mock for test: test_invalid_model_noninteractive in module: tests.unit.chat_completions_tests.test_error_handling
2025-08-20 18:57:12 [info     ] API Key authentication is disabled
----------------------------- Captured log setup ------------------------------
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: MockBackendStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.test_stages:test_stages.py:43 Initializing mock backend services...
DEBUG    src.core.app.stages.test_stages:test_stages.py:87 Registered mock backend config provider
DEBUG    src.core.app.stages.test_stages:test_stages.py:345 Registered mock backend factory
DEBUG    src.core.app.stages.test_stages:test_stages.py:310 Registered mock backend service with full method coverage
DEBUG    src.core.app.stages.test_stages:test_stages.py:427 Overrode session service to ensure real Session objects
INFO     src.core.app.stages.test_stages:test_stages.py:60 Mock backend services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 12 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
------------------------------ Captured log call ------------------------------
DEBUG    src.core.app.stages.processor:processor.py:167 Added loop detection middleware
INFO     src.core.app.controllers.chat_controller:chat_controller.py:68 Handling chat completion request: model=m
INFO     src.core.app.stages.test_stages:test_stages.py:171 Mock backend returning JSON response for model: mock-model
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/chat/completions "HTTP/1.1 200 OK"
---------------------------- Captured log teardown ----------------------------
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
___________________________ test_rate_limit_memory ____________________________

httpx_mock_client = <starlette.testclient.TestClient object at 0x000001F6F764BA30>
httpx_mock = <pytest_httpx._httpx_mock.HTTPXMock object at 0x000001F6F765B760>

    @pytest.mark.httpx_mock(assert_all_responses_were_requested=False, assert_all_requests_were_expected=False)
    def test_rate_limit_memory(
        httpx_mock_client, httpx_mock: HTTPXMock
    ):  # Use custom client fixture
        httpx_mock.non_mocked_hosts = []  # Mock all hosts
    
        httpx_mock.add_response(
            url="https://api.openai.com/v1/models", json={"data": [{"id": "dummy"}]}
        )
    
        # Add multiple OpenAI responses to handle multiple calls
        httpx_mock.add_response(
            url="https://api.openai.com/v1/chat/completions",
            method="POST",
            status_code=200,
            json={"choices": [{"message": {"content": "mocked openai response"}}]},
        )
    
        # Add another OpenAI response for the second call
        httpx_mock.add_response(
            url="https://api.openai.com/v1/chat/completions",
            method="POST",
            status_code=200,
            json={"choices": [{"message": {"content": "mocked openai response"}}]},
        )
    
        error_detail = {
            "error": {
                "code": 429,
                "message": "quota exceeded",
                "status": "RESOURCE_EXHAUSTED",
                "details": [
                    {
                        "@type": "type.googleapis.com/google.rpc.RetryInfo",
                        "retryDelay": "1s",
                    }
                ],
            }
        }
    
        # Mock the Gemini responses using a callback to handle multiple requests
        httpx_mock.add_response(
            url=re.compile(
                r"https://generativelanguage.googleapis.com/v1beta/models/gemini-1:generateContent.*"
            ),
            method="POST",
            status_code=429,
            json=error_detail,
        )
        httpx_mock.add_response(
            url=re.compile(
                r"https://generativelanguage.googleapis.com/v1beta/models/gemini-1:generateContent.*"
            ),
            method="POST",
            status_code=200,
            json={
                "candidates": [{"content": {"parts": [{"text": "ok"}]}}],
                "usageMetadata": {
                    "promptTokenCount": 0,
                    "candidatesTokenCount": 0,
                    "totalTokenCount": 0,
                },
            },
        )
    
        # Use a command to set the backend to gemini
        set_backend_payload = {
            "model": "some-model",
            "messages": [{"role": "user", "content": "!/set(backend=gemini)"}],
        }
        httpx_mock_client.post("/v1/chat/completions", json=set_backend_payload)
    
        payload = {"model": "gemini-1", "messages": [{"role": "user", "content": "hi"}]}
        r1 = httpx_mock_client.post("/v1/chat/completions", json=payload)
        # The test may fail before using all mocks, so only assert if successful
        if r1.status_code == 200:
            try:
                response_json = r1.json()
                # If we can parse the JSON and it's a dict, check the structure
                if isinstance(response_json, dict) and "choices" in response_json:
>                   assert response_json["choices"][0]["message"]["content"].endswith("ok")
E                   AssertionError: assert False
E                    +  where False = <built-in method endswith of str object at 0x000001F6F72FB4B0>('ok')
E                    +    where <built-in method endswith of str object at 0x000001F6F72FB4B0> = 'mocked openai response'.endswith

tests\unit\chat_completions_tests\test_rate_limiting.py:99: AssertionError
---------------------------- Captured stdout setup ----------------------------
SKIPPING global mock for test: test_rate_limit_memory in module: tests.unit.chat_completions_tests.test_rate_limiting
2025-08-20 18:57:14 [info     ] API Key authentication is disabled
----------------------------- Captured log setup ------------------------------
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CoreServicesStage(name='core_services')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: InfrastructureStage(name='infrastructure')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: RealBackendTestStage(name='backends')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: CommandStage(name='commands')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ProcessorStage(name='processors')
DEBUG    src.core.app.application_builder:application_builder.py:63 Added stage: ControllerStage(name='controllers')
INFO     src.core.app.application_builder:application_builder.py:186 Starting application build process...
INFO     src.core.app.application_builder:application_builder.py:193 Executing stages in order: ['core_services', 'infrastructure', 'commands', 'backends', 'processors', 'controllers']
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: core_services
INFO     src.core.app.stages.core_services:core_services.py:44 Initializing core services...
DEBUG    src.core.app.stages.core_services:core_services.py:48 Registered AppConfig instance
DEBUG    src.core.app.stages.core_services:core_services.py:79 Registered session repository services
DEBUG    src.core.app.stages.core_services:core_services.py:112 Registered session service with factory
DEBUG    src.core.app.stages.core_services:core_services.py:135 Registered session resolver instance
INFO     src.core.app.stages.core_services:core_services.py:59 Core services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'core_services' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: infrastructure
INFO     src.core.app.stages.infrastructure:infrastructure.py:47 Initializing infrastructure services...
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:71 Registered shared HTTP client
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:83 Registered rate limiter service
DEBUG    src.core.app.stages.infrastructure:infrastructure.py:101 Registered loop detector with interface binding
INFO     src.core.app.stages.infrastructure:infrastructure.py:58 Infrastructure services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'infrastructure' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: commands
INFO     src.core.app.stages.command:command.py:45 Initializing command services...
DEBUG    src.core.app.stages.command:command.py:69 Registered command registry
DEBUG    src.core.app.stages.command:command.py:97 Registered command settings service
DEBUG    src.core.app.stages.command:command.py:133 Registered command service with dependencies
INFO     src.core.app.stages.command:command.py:59 Command services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'commands' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: backends
INFO     src.core.app.stages.test_stages:test_stages.py:523 Initializing real backend services for HTTP mocking tests...
INFO     src.core.app.stages.backend:backend.py:52 Initializing backend services...
DEBUG    src.core.app.stages.backend:backend.py:57 Imported connectors, registered backends: ['gemini', 'openai', 'openrouter', 'qwen-oauth', 'zai']
DEBUG    src.core.app.stages.backend:backend.py:88 Registered backend registry instance
DEBUG    src.core.app.stages.backend:backend.py:116 Registered backend factory with dependencies
DEBUG    src.core.app.stages.backend:backend.py:141 Registered backend config provider
DEBUG    src.core.app.stages.backend:backend.py:189 Registered backend service with all dependencies
INFO     src.core.app.stages.backend:backend.py:75 Backend services initialized successfully
DEBUG    src.core.app.stages.test_stages:test_stages.py:567 Overrode session service to ensure real Session objects
INFO     src.core.app.stages.test_stages:test_stages.py:535 Real backend services for HTTP mocking initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'backends' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: processors
INFO     src.core.app.stages.processor:processor.py:49 Initializing processor services...
DEBUG    src.core.app.stages.processor:processor.py:98 Registered command processor
DEBUG    src.core.app.stages.processor:processor.py:137 Registered backend processor
DEBUG    src.core.app.stages.processor:processor.py:187 Registered response processor with middleware
DEBUG    src.core.app.stages.processor:processor.py:253 Registered request processor with all dependencies
INFO     src.core.app.stages.processor:processor.py:63 Processor services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'processors' completed successfully
INFO     src.core.app.application_builder:application_builder.py:198 Executing stage: controllers
INFO     src.core.app.stages.controller:controller.py:47 Initializing controller services...
DEBUG    src.core.app.stages.controller:controller.py:85 Registered chat controller
DEBUG    src.core.app.stages.controller:controller.py:115 Registered anthropic controller
DEBUG    src.core.app.stages.controller:controller.py:141 Registered models controller
DEBUG    src.core.app.stages.controller:controller.py:168 Registered usage controller
INFO     src.core.app.stages.controller:controller.py:61 Controller services initialized successfully
DEBUG    src.core.app.application_builder:application_builder.py:202 Stage 'controllers' completed successfully
INFO     src.core.app.application_builder:application_builder.py:209 Service provider built successfully
DEBUG    src.core.app.application_builder:application_builder.py:283 Discovered 13 API keys for redaction
INFO     src.core.app.controllers:__init__.py:156 Routes registered successfully
INFO     src.core.app.application_builder:application_builder.py:213 FastAPI application created successfully
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
INFO     src.core.app.application_builder:application_builder.py:340 Application startup complete
---------------------------- Captured stdout call -----------------------------
2025-08-20 18:57:14 [debug    ] Initialized failover service   failover_routes={}
------------------------------ Captured log call ------------------------------
DEBUG    src.core.app.stages.processor:processor.py:167 Added loop detection middleware
INFO     src.core.app.controllers.chat_controller:chat_controller.py:68 Handling chat completion request: model=some-model
INFO     src.core.services.backend_service:backend_service.py:107 Determined default_backend: openai
INFO     src.core.services.backend_service:backend_service.py:113 Result of parse_model_backend: (openai, some-model)
INFO     src.core.services.backend_service:backend_service.py:119 Final effective_model=some-model, backend_type=openai
INFO     src.core.services.backend_service:backend_service.py:136 Effective failover routes for request: []
INFO     src.core.services.backend_service:backend_service.py:140 Request.extra_body keys: ['model', 'messages', 'temperature', 'top_p', 'n', 'stream', 'stop', 'max_tokens', 'presence_penalty', 'frequency_penalty', 'logit_bias', 'user', 'tools', 'tool_choice', 'session_id', 'extra_body', 'reasoning_effort', 'reasoning', 'thinking_budget', 'generation_config']
INFO     src.core.services.backend_service:backend_service.py:144 Effective_model=some-model, backend_type=openai
INFO     src.core.services.backend_factory:backend_factory.py:114 Factory initializing backend openai with {'api_key': '***'}
INFO     src.connectors.openai:openai.py:48 OpenAIConnector initialize called. api_key: ***
INFO     httpx:_client.py:1740 HTTP Request: GET https://api.openai.com/v1/models "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/chat/completions "HTTP/1.1 200 OK"
INFO     src.core.app.controllers.chat_controller:chat_controller.py:68 Handling chat completion request: model=gemini-1
INFO     src.core.services.backend_service:backend_service.py:107 Determined default_backend: openai
INFO     src.core.services.backend_service:backend_service.py:113 Result of parse_model_backend: (openai, gemini-1)
INFO     src.core.services.backend_service:backend_service.py:119 Final effective_model=gemini-1, backend_type=openai
INFO     src.core.services.backend_service:backend_service.py:136 Effective failover routes for request: []
INFO     src.core.services.backend_service:backend_service.py:140 Request.extra_body keys: ['model', 'messages', 'temperature', 'top_p', 'n', 'stream', 'stop', 'max_tokens', 'presence_penalty', 'frequency_penalty', 'logit_bias', 'user', 'tools', 'tool_choice', 'session_id', 'extra_body', 'reasoning_effort', 'reasoning', 'thinking_budget', 'generation_config']
INFO     src.core.services.backend_service:backend_service.py:144 Effective_model=gemini-1, backend_type=openai
INFO     httpx:_client.py:1740 HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO     src.core.services.request_processor_service:request_processor_service.py:178 Session updated in repository
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/v1/chat/completions "HTTP/1.1 200 OK"
---------------------------- Captured log teardown ----------------------------
INFO     src.core.app.application_builder:application_builder.py:343 Shutting down application
__________________ TestBuildApp.test_build_app_loads_config ___________________

self = <test_application_factory.TestBuildApp object at 0x000001F6F32BBD60>
mock_from_env = <MagicMock name='from_env' id='2160247505632'>
mock_build_app_async = <SmartAsyncMock name='build_app_async' id='2160247833984'>

    @patch("src.core.app.application_builder.build_app_async")
    @patch("src.core.config.app_config.AppConfig.from_env")
    def test_build_app_loads_config(self, mock_from_env, mock_build_app_async):
        """Test that build_app loads configuration."""
        mock_config_instance = MagicMock()
        mock_from_env.return_value = mock_config_instance
        mock_fastapi_app = MagicMock(spec=FastAPI)
    
        # Create a coroutine mock that returns the FastAPI app
        async def mock_async_build(config):
            return mock_fastapi_app
    
        mock_build_app_async.return_value = mock_async_build(mock_config_instance)
    
        app = build_app()
    
        # Verify AppConfig.from_env was called
        mock_from_env.assert_called_once()
    
        # Verify build_app_async was called with the config
        mock_build_app_async.assert_called_once_with(mock_config_instance)
    
        # Verify the app is returned
>       assert app is mock_fastapi_app
E       AssertionError: assert <coroutine object TestBuildApp.test_build_app_loads_config.<locals>.mock_async_build at 0x000001F6F7863610> is <MagicMock spec='FastAPI' id='2160247617712'>

tests\unit\core\app\test_application_factory.py:121: AssertionError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_build_app_loads_config in module: test_application_factory
_______________ TestBuildApp.test_build_app_creates_fastapi_app _______________

self = <test_application_factory.TestBuildApp object at 0x000001F6F32BBFA0>
mock_from_env = <MagicMock name='from_env' id='2160247501632'>
mock_build_app_async = <SmartAsyncMock name='build_app_async' id='2160247862272'>

    @patch("src.core.app.application_builder.build_app_async")
    @patch("src.core.config.app_config.AppConfig.from_env")
    def test_build_app_creates_fastapi_app(self, mock_from_env, mock_build_app_async):
        """Test that build_app creates a FastAPI application."""
        mock_config_instance = MagicMock()
        mock_from_env.return_value = mock_config_instance
    
        # Mock FastAPI app with title
        mock_fastapi_app = MagicMock(spec=FastAPI, title="LLM Interactive Proxy")
    
        # Create a coroutine mock that returns the FastAPI app
        async def mock_async_build(config):
            return mock_fastapi_app
    
        mock_build_app_async.return_value = mock_async_build(mock_config_instance)
    
        app = build_app()
    
>       assert app is mock_fastapi_app
E       AssertionError: assert <coroutine object TestBuildApp.test_build_app_creates_fastapi_app.<locals>.mock_async_build at 0x000001F6F75B1D90> is <MagicMock spec='FastAPI' id='2160247612384'>

tests\unit\core\app\test_application_factory.py:141: AssertionError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_build_app_creates_fastapi_app in module: test_application_factory
________________ TestBuildApp.test_build_app_sets_up_app_state ________________

self = <test_application_factory.TestBuildApp object at 0x000001F6F32E4160>
mock_from_env = <MagicMock name='from_env' id='2160248331744'>
mock_build_app_async = <SmartAsyncMock name='build_app_async' id='2160247969520'>

    @patch("src.core.app.application_builder.build_app_async")
    @patch("src.core.config.app_config.AppConfig.from_env")
    def test_build_app_sets_up_app_state(self, mock_from_env, mock_build_app_async):
        """Test that build_app sets up app state correctly."""
        mock_config_instance = MagicMock()
        mock_from_env.return_value = mock_config_instance
    
        # Create a mock FastAPI app
        mock_fastapi_app = MagicMock(spec=FastAPI)
    
        # Create a proper state mock object
        mock_state = MagicMock()
        mock_state.app_config = mock_config_instance
        mock_state.service_provider = MagicMock()
        mock_state.service_provider.get_service = MagicMock()
    
        # Attach the state to the app
        mock_fastapi_app.state = mock_state
    
        # Create a coroutine mock that returns the FastAPI app
        async def mock_async_build(config):
            return mock_fastapi_app
    
        mock_build_app_async.return_value = mock_async_build(mock_config_instance)
    
        app = build_app()
    
        # Verify the app state is set up correctly
>       assert hasattr(app.state, "app_config")
E       AttributeError: 'coroutine' object has no attribute 'state'

tests\unit\core\app\test_application_factory.py:172: AttributeError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_build_app_sets_up_app_state in module: test_application_factory
___________________ test_streaming_response_async_iterator ____________________

connector = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8E47E80>

    @pytest.mark.asyncio
    async def test_streaming_response_async_iterator(connector):
        """Test handling a streaming response with an async iterator."""
        # Create a mock response with an async iterator
        chunks = [b"chunk1", b"chunk2", b"chunk3"]
        mock_response = MockResponse(headers={"Content-Type": "text/event-stream"})
        mock_response.aiter_bytes = lambda: AsyncIterBytes(chunks)
    
        # Mock the client.send method to return our mock response
        connector.client.send = AsyncMock(return_value=mock_response)
    
        # Create a mock ChatRequest with streaming enabled
        from src.core.domain.chat import ChatMessage, ChatRequest
    
        request_data = ChatRequest(
            model="test-model",
            messages=[ChatMessage(role="user", content="test")],
            stream=True,
        )
    
        # Call the method
>       result = await connector.chat_completions(
            request_data, [{"role": "user", "content": "test"}], "test-model"
        )

tests\unit\openai_connector_tests\test_streaming_response.py:102: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\connectors\openai.py:111: in chat_completions
    content_iterator = await self._handle_streaming_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8E47E80>
url = 'https://api.openai.com/v1/chat/completions'
payload = {'messages': [{'content': 'test', 'role': 'user'}], 'model': 'test-model', 'stream': True}
headers = {'Authorization': 'Bearer test-api-key'}

    async def _handle_streaming_response(
        self, url: str, payload: dict[str, Any], headers: dict[str, str] | None
    ) -> AsyncIterator[bytes]:
        """Return an AsyncIterator of bytes directly (transport-agnostic)"""
    
        if not headers or not headers.get("Authorization"):
            raise AuthenticationError(message="No auth credentials found")
    
        request = self.client.build_request("POST", url, json=payload, headers=headers)
        try:
>           response = await self.client.send(request, stream=True)
E           TypeError: object MockResponse can't be used in 'await' expression

src\connectors\openai.py:161: TypeError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_streaming_response_async_iterator in module: tests.unit.openai_connector_tests.test_streaming_response
----------------------------- Captured log setup ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
____________________ test_streaming_response_sync_iterator ____________________

connector = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8EA9C90>

    @pytest.mark.asyncio
    async def test_streaming_response_sync_iterator(connector):
        """Test handling a streaming response with a sync iterator."""
        # Create a mock response with a sync iterator
        chunks = [b"chunk1", b"chunk2", b"chunk3"]
        mock_response = MockResponse(headers={"Content-Type": "text/event-stream"})
        mock_response.aiter_bytes = lambda: SyncIterBytes(chunks)
    
        # Mock the client.send method to return our mock response
        connector.client.send = AsyncMock(return_value=mock_response)
    
        # Create a mock ChatRequest with streaming enabled
        from src.core.domain.chat import ChatMessage, ChatRequest
    
        request_data = ChatRequest(
            model="test-model",
            messages=[ChatMessage(role="user", content="test")],
            stream=True,
        )
    
        # Call the method
>       result = await connector.chat_completions(
            request_data, [{"role": "user", "content": "test"}], "test-model"
        )

tests\unit\openai_connector_tests\test_streaming_response.py:143: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\connectors\openai.py:111: in chat_completions
    content_iterator = await self._handle_streaming_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8EA9C90>
url = 'https://api.openai.com/v1/chat/completions'
payload = {'messages': [{'content': 'test', 'role': 'user'}], 'model': 'test-model', 'stream': True}
headers = {'Authorization': 'Bearer test-api-key'}

    async def _handle_streaming_response(
        self, url: str, payload: dict[str, Any], headers: dict[str, str] | None
    ) -> AsyncIterator[bytes]:
        """Return an AsyncIterator of bytes directly (transport-agnostic)"""
    
        if not headers or not headers.get("Authorization"):
            raise AuthenticationError(message="No auth credentials found")
    
        request = self.client.build_request("POST", url, json=payload, headers=headers)
        try:
>           response = await self.client.send(request, stream=True)
E           TypeError: object MockResponse can't be used in 'await' expression

src\connectors\openai.py:161: TypeError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_streaming_response_sync_iterator in module: tests.unit.openai_connector_tests.test_streaming_response
----------------------------- Captured log setup ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
______________________ test_streaming_response_coroutine ______________________

connector = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8DE7790>

    @pytest.mark.asyncio
    async def test_streaming_response_coroutine(connector):
        """Test handling a streaming response with a coroutine."""
        # Create a mock response with a coroutine that returns an iterable
        chunks = [b"chunk1", b"chunk2", b"chunk3"]
        mock_response = MockResponse(headers={"Content-Type": "text/event-stream"})
    
        async def mock_aiter_bytes():
            return chunks
    
        mock_response.aiter_bytes = mock_aiter_bytes
    
        # Mock the client.send method to return our mock response
        connector.client.send = AsyncMock(return_value=mock_response)
    
        # Create a mock ChatRequest with streaming enabled
        from src.core.domain.chat import ChatMessage, ChatRequest
    
        request_data = ChatRequest(
            model="test-model",
            messages=[ChatMessage(role="user", content="test")],
            stream=True,
        )
    
        # Call the method
>       result = await connector.chat_completions(
            request_data, [{"role": "user", "content": "test"}], "test-model"
        )

tests\unit\openai_connector_tests\test_streaming_response.py:188: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\connectors\openai.py:111: in chat_completions
    content_iterator = await self._handle_streaming_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8DE7790>
url = 'https://api.openai.com/v1/chat/completions'
payload = {'messages': [{'content': 'test', 'role': 'user'}], 'model': 'test-model', 'stream': True}
headers = {'Authorization': 'Bearer test-api-key'}

    async def _handle_streaming_response(
        self, url: str, payload: dict[str, Any], headers: dict[str, str] | None
    ) -> AsyncIterator[bytes]:
        """Return an AsyncIterator of bytes directly (transport-agnostic)"""
    
        if not headers or not headers.get("Authorization"):
            raise AuthenticationError(message="No auth credentials found")
    
        request = self.client.build_request("POST", url, json=payload, headers=headers)
        try:
>           response = await self.client.send(request, stream=True)
E           TypeError: object MockResponse can't be used in 'await' expression

src\connectors\openai.py:161: TypeError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_streaming_response_coroutine in module: tests.unit.openai_connector_tests.test_streaming_response
----------------------------- Captured log setup ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
________________________ test_streaming_response_error ________________________

connector = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8FAD8D0>

    @pytest.mark.asyncio
    async def test_streaming_response_error(connector):
        """Test handling a streaming response with an error."""
        # Create a mock response with an error
        mock_response = MockResponse(
            status_code=400, content=b'{"error": "Bad request"}', is_error=True
        )
    
        # Mock the client.send method to return our mock response
        connector.client.send = AsyncMock(return_value=mock_response)
    
        # Create a mock ChatRequest with streaming enabled
        from src.core.domain.chat import ChatMessage, ChatRequest
    
        request_data = ChatRequest(
            model="test-model",
            messages=[ChatMessage(role="user", content="test")],
            stream=True,
        )
    
        # Call the method and expect an exception
        with pytest.raises(HTTPException) as excinfo:
>           await connector.chat_completions(
                request_data, [{"role": "user", "content": "test"}], "test-model"
            )

tests\unit\openai_connector_tests\test_streaming_response.py:230: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\connectors\openai.py:111: in chat_completions
    content_iterator = await self._handle_streaming_response(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.connectors.openai.OpenAIConnector object at 0x000001F6F8FAD8D0>
url = 'https://api.openai.com/v1/chat/completions'
payload = {'messages': [{'content': 'test', 'role': 'user'}], 'model': 'test-model', 'stream': True}
headers = {'Authorization': 'Bearer test-api-key'}

    async def _handle_streaming_response(
        self, url: str, payload: dict[str, Any], headers: dict[str, str] | None
    ) -> AsyncIterator[bytes]:
        """Return an AsyncIterator of bytes directly (transport-agnostic)"""
    
        if not headers or not headers.get("Authorization"):
            raise AuthenticationError(message="No auth credentials found")
    
        request = self.client.build_request("POST", url, json=payload, headers=headers)
        try:
>           response = await self.client.send(request, stream=True)
E           TypeError: object MockResponse can't be used in 'await' expression

src\connectors\openai.py:161: TypeError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_streaming_response_error in module: tests.unit.openai_connector_tests.test_streaming_response
----------------------------- Captured log setup ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
__________ TestQwenOAuthConnectorUnit.test_chat_completions_success ___________

self = <tests.unit.test_qwen_oauth_connector.TestQwenOAuthConnectorUnit object at 0x000001F6F35F6CE0>
connector = <src.connectors.qwen_oauth.QwenOAuthConnector object at 0x000001F6F8EEF6A0>
mock_client = <MagicMock spec='AsyncClient' id='2160250172368'>

    @pytest.mark.asyncio
    async def test_chat_completions_success(self, connector, mock_client):
        """Test successful chat completion."""
        # Setup
        connector._oauth_credentials = {
            "access_token": "test-token",
            "resource_url": "portal.qwen.ai",
        }
        connector.api_base_url = "https://portal.qwen.ai/v1"
    
        test_message = ChatMessage(role="user", content="Hello")
        request_data = ChatRequest(
            model="qwen3-coder-plus", messages=[test_message], stream=False
        )
    
        # Mock successful API response
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "id": "test-id",
            "choices": [
                {
                    "message": {"role": "assistant", "content": "Hello!"},
                    "finish_reason": "stop",
                }
            ],
            "usage": {"prompt_tokens": 1, "completion_tokens": 1, "total_tokens": 2},
        }
        mock_response.headers = {"content-type": "application/json"}
        mock_client.post = AsyncMock(return_value=mock_response)
    
        # Mock parent class methods
        with (
            patch.object(
                connector, "_refresh_token_if_needed", AsyncMock(return_value=True)
            ),
            patch.object(
                connector,
                "_prepare_payload",
                return_value={
                    "model": "qwen3-coder-plus",
                    "messages": [{"role": "user", "content": "Hello"}],
                },
            ),
            patch.object(
                connector,
                "_handle_non_streaming_response",
                AsyncMock(
                    return_value=(
                        mock_response.json.return_value,
                        mock_response.headers,
                    )
                ),
            ),
        ):
    
            result = await connector.chat_completions(
                request_data=request_data,
                processed_messages=[test_message],
                effective_model="qwen3-coder-plus",
            )
    
>           assert isinstance(result, ResponseEnvelope)
E           AssertionError: assert False
E            +  where False = isinstance(({'choices': [{'finish_reason': 'stop', 'message': {'content': 'Hello!', 'role': 'assistant'}}], 'id': 'test-id', 'usage': {'completion_tokens': 1, 'prompt_tokens': 1, 'total_tokens': 2}}, {'content-type': 'application/json'}), ResponseEnvelope)

tests\unit\test_qwen_oauth_connector.py:324: AssertionError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_chat_completions_success in module: tests.unit.test_qwen_oauth_connector
----------------------------- Captured log setup ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
________ TestQwenOAuthConnectorUnit.test_chat_completions_with_prefix _________

self = <tests.unit.test_qwen_oauth_connector.TestQwenOAuthConnectorUnit object at 0x000001F6F35D4E20>
connector = <src.connectors.qwen_oauth.QwenOAuthConnector object at 0x000001F6F88EA5F0>
mock_client = <MagicMock spec='AsyncClient' id='2160243685840'>

    @pytest.mark.asyncio
    async def test_chat_completions_with_prefix(self, connector, mock_client):
        """Test chat completion with qwen-oauth: prefix in model name."""
        # Setup
        connector._oauth_credentials = {
            "access_token": "test-token",
            "resource_url": "portal.qwen.ai",
        }
        connector.api_base_url = "https://portal.qwen.ai/v1"
    
        test_message = ChatMessage(role="user", content="Hello")
        request_data = ChatRequest(
            model="qwen-oauth:qwen3-coder-plus", messages=[test_message], stream=False
        )
    
        # Mock successful API response
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "id": "test-id",
            "choices": [
                {
                    "message": {"role": "assistant", "content": "Hello!"},
                    "finish_reason": "stop",
                }
            ],
            "usage": {"prompt_tokens": 1, "completion_tokens": 1, "total_tokens": 2},
        }
        mock_response.headers = {"content-type": "application/json"}
    
        # Create a mock for the parent class method
        parent_mock = AsyncMock(
            return_value=(mock_response.json.return_value, mock_response.headers)
        )
    
        # Mock parent class methods
        with (
            patch.object(
                connector, "_refresh_token_if_needed", AsyncMock(return_value=True)
            ),
            patch(
                "src.connectors.openai.OpenAIConnector.chat_completions", parent_mock
            ),
        ):
    
            result = await connector.chat_completions(
                request_data=request_data,
                processed_messages=[test_message],
                effective_model="qwen-oauth:qwen3-coder-plus",
            )
    
            # Verify the prefix was stripped
            # Check that the parent method was called with the correct model name
            assert parent_mock.call_args is not None
            _, kwargs = parent_mock.call_args
            assert kwargs["effective_model"] == "qwen3-coder-plus"
    
>           assert isinstance(result, ResponseEnvelope)
E           AssertionError: assert False
E            +  where False = isinstance(({'choices': [{'finish_reason': 'stop', 'message': {'content': 'Hello!', 'role': 'assistant'}}], 'id': 'test-id', 'usage': {'completion_tokens': 1, 'prompt_tokens': 1, 'total_tokens': 2}}, {'content-type': 'application/json'}), ResponseEnvelope)

tests\unit\test_qwen_oauth_connector.py:385: AssertionError
---------------------------- Captured stdout setup ----------------------------
APPLYING global mock for test: test_chat_completions_with_prefix in module: tests.unit.test_qwen_oauth_connector
----------------------------- Captured log setup ------------------------------
DEBUG    asyncio:proactor_events.py:630 Using proactor: IocpProactor
============================== warnings summary ===============================
dev\test_api_key_redaction.py:51
  C:\Users\Mateusz\source\repos\llm-interactive-proxy\dev\test_api_key_redaction.py:51: PytestCollectionWarning: cannot collect test class 'TestLogHandler' because it has a __init__ constructor (from: dev/test_api_key_redaction.py)
    class TestLogHandler(logging.Handler):

src\core\app\test_builder.py:35
  C:\Users\Mateusz\source\repos\llm-interactive-proxy\src\core\app\test_builder.py:35: PytestCollectionWarning: cannot collect test class 'ApplicationTestBuilder' because it has a __init__ constructor (from: src/core/app/test_builder.py)
    class ApplicationTestBuilder(ApplicationBuilder):

tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_sets_up_app_state
  C:\Program Files\Python310\lib\unittest\mock.py:2181: RuntimeWarning: coroutine 'TestBuildApp.test_build_app_loads_config.<locals>.mock_async_build' was never awaited
    self.name = name
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_sets_up_app_state
  C:\Program Files\Python310\lib\unittest\mock.py:2181: RuntimeWarning: coroutine 'TestBuildApp.test_build_app_creates_fastapi_app.<locals>.mock_async_build' was never awaited
    self.name = name
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/unit/gemini_connector_tests/test_temperature_handling.py::TestGeminiTemperatureHandling::test_temperature_zero_value
  C:\Program Files\Python310\lib\inspect.py:2218: RuntimeWarning: coroutine 'TestBuildApp.test_build_app_sets_up_app_state.<locals>.mock_async_build' was never awaited
    defaults = reversed(f.args.defaults)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_loop_detection_command.py:35: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_loop_detection_command.py:43: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_loop_detection_command.py:51: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_detection_command.py:35: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_detection_command.py:43: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_detection_command.py:51: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_max_repeats_command.py:35: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_max_repeats_command.py:43: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_mode_command.py:35: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_mode_command.py:43: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_ttl_command.py:33: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\loop_detection_commands\test_integration_tool_loop_ttl_command.py:41: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\commands\test_integration_failover_commands.py:49: Snapshot fixture not available - requires significant test infrastructure setup
SKIPPED [1] tests\integration\test_anthropic_frontend_integration.py:367: Testing fallback when anthropic not available
SKIPPED [1] tests\integration\test_backend_probing.py:137: Global mock interferes with service registration - needs investigation
SKIPPED [1] tests\integration\test_cline_tool_call_implementation.py:108: Needs deeper refactoring to handle Cline command responses correctly
SKIPPED [1] tests\integration\test_cline_tool_call_implementation.py:201: Needs deeper refactoring to handle Cline command responses correctly
SKIPPED [11] tests\integration\test_cline_tool_call_implementation.py: Needs deeper refactoring to handle Cline command responses correctly
SKIPPED [1] tests\integration\test_end_to_end_loop_detection.py:43: Loop detection integration requires complex middleware setup and configuration - skipping for now
SKIPPED [1] tests\integration\test_end_to_end_loop_detection.py:141: Test uses deprecated _initialize_loop_detection_middleware method that no longer exists in new architecture
SKIPPED [1] tests\integration\test_end_to_end_loop_detection.py:301: Test uses deprecated initialization methods that no longer exist in new architecture
SKIPPED [1] tests\integration\test_end_to_end_loop_detection.py:359: Needs further investigation of AsyncMock behavior
SKIPPED [1] tests\integration\test_failover_routes.py:29: Complex failover command integration requires specialized service setup - skipping for now
SKIPPED [1] tests\integration\test_models_endpoints.py:75: Test isolation issue - passes individually but fails in full suite
SKIPPED [1] tests\integration\test_tool_call_loop_detection.py:180: Complex tool call loop detection test with multiple scenarios - requires deeper integration testing
SKIPPED [1] tests\integration\test_tool_call_loop_detection.py:252: CHANCE_THEN_BREAK mode not fully implemented yet
SKIPPED [1] tests\integration\test_tool_call_loop_detection.py:325: CHANCE_THEN_BREAK mode not fully implemented yet
SKIPPED [1] tests\integration\test_tool_call_loop_detection.py:391: Complex tool call loop detection test - requires specialized integration setup
SKIPPED [1] tests\integration\test_tool_call_loop_detection.py:441: Complex tool call loop detection test - requires specialized integration setup
SKIPPED [1] tests\integration\test_tool_call_loop_detection.py:485: Needs proper test isolation for backend mocking
SKIPPED [1] tests\unit\chat_completions_tests\test_multimodal_cross_protocol.py:126: Global mock interferes with AsyncMock - needs investigation
SKIPPED [1] tests\unit\chat_completions_tests\test_rate_limit_wait.py:9: Test needs to be rewritten to work with global mock
SKIPPED [7] tests\unit\chat_completions_tests\test_real_cline_response.py: Tests require complex backend mocking that's currently broken
SKIPPED [1] tests\unit\chat_completions_tests\test_session_history.py:10: Test needs to be rewritten to work with global mock
SKIPPED [1] tests\unit\chat_completions_tests\test_session_history.py:70: Test needs to be rewritten to work with global mock
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_loop_detection_command.py:24: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_loop_detection_command.py:41: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_loop_detection_command.py:63: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_detection_command.py:24: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_detection_command.py:43: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_detection_command.py:65: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_max_repeats_command.py:22: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_max_repeats_command.py:41: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_max_repeats_command.py:59: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_max_repeats_command.py:77: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [2] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_mode_command.py:23: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_mode_command.py:43: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_mode_command.py:61: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_ttl_command.py:22: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_ttl_command.py:39: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_ttl_command.py:55: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\commands\loop_detection_commands\test_unit_tool_loop_ttl_command.py:71: Loop detection is disabled due to legacy/invalid implementation. TODO: Implement gemini-cli inspired fast hash-based loop detection.
SKIPPED [1] tests\unit\core\test_backend_service_enhanced.py:234: _prepare_messages is now implemented in each backend connector, not in BackendService
SKIPPED [1] tests\unit\openai_connector_tests\test_integration.py:76: Complex coroutine serialization issue in command/response pipeline - requires deeper debugging
SKIPPED [1] tests\unit\test_cli.py:189: Test for non-Windows systems
SKIPPED [1] tests\unit\test_cli.py:198: Test for non-Windows systems
SKIPPED [1] tests\unit\test_mock_backends.py:185: Global mock overrides custom backend configuration
SKIPPED [1] tests\unit\test_mock_backends.py:218: Requires proper app setup with service provider
SKIPPED [1] tests\unit\test_mock_backends.py:261: This test requires real API keys and real backends
SKIPPED [1] tests\unit\test_qwen_oauth_interactive_commands.py:27: Skip due to MagicMock issues with apply_cli_args
SKIPPED [1] tests\unit\test_qwen_oauth_interactive_commands.py:31: Skipping test that requires Qwen OAuth backend to be enabled
SKIPPED [1] tests\unit\test_qwen_oauth_interactive_commands.py:62: Skipping test that requires Qwen OAuth backend to be enabled
SKIPPED [1] tests\unit\test_qwen_oauth_interactive_commands.py:165: Skipping test that requires Qwen OAuth backend to be enabled
FAILED tests/integration/test_models_endpoints.py::TestModelsEndpoints::test_models_endpoint_with_auth
FAILED tests/integration/test_new_architecture.py::test_anthropic_endpoint - ...
FAILED tests/unit/chat_completions_tests/test_error_handling.py::test_invalid_model_noninteractive
FAILED tests/unit/chat_completions_tests/test_rate_limiting.py::test_rate_limit_memory
FAILED tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_loads_config
FAILED tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_creates_fastapi_app
FAILED tests/unit/core/app/test_application_factory.py::TestBuildApp::test_build_app_sets_up_app_state
FAILED tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_async_iterator
FAILED tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_sync_iterator
FAILED tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_coroutine
FAILED tests/unit/openai_connector_tests/test_streaming_response.py::test_streaming_response_error
FAILED tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_success
FAILED tests/unit/test_qwen_oauth_connector.py::TestQwenOAuthConnectorUnit::test_chat_completions_with_prefix
=== 13 failed, 728 passed, 80 skipped, 43 deselected, 5 warnings in 27.43s ====
